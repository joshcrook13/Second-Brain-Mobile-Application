<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Personal CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { crm: { bg: '#020617', card: '#1e293b', accent: '#6366f1' } }
                }
            }
        }
    </script>
    <style>
        body { background-color: #020617; color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        
        .glass-panel { background: rgba(30, 41, 59, 0.4); border: 1px solid rgba(255, 255, 255, 0.05); backdrop-filter: blur(12px); }
        .glass-input { background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(255, 255, 255, 0.1); color: white; border-radius: 12px; transition: all 0.2s; }
        .glass-input:focus { outline: none; border-color: #6366f1; background: rgba(15, 23, 42, 0.9); }

        .tab-btn.active { color: #6366f1; border-bottom: 2px solid #6366f1; }
        .tab-btn { color: #94a3b8; border-bottom: 2px solid transparent; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden bg-[#020617]">

    <header class="h-16 flex items-center justify-between px-5 bg-[#020617] border-b border-slate-800 shrink-0 z-20">
        <h1 class="text-lg font-bold flex items-center gap-2"><i class="ph ph-users-three text-indigo-500 text-xl"></i> CRM</h1>
        <button onclick="openEditModal()" class="w-9 h-9 rounded-full bg-indigo-600 flex items-center justify-center text-white shadow-lg active:scale-90 transition-transform"><i class="ph ph-plus-bold"></i></button>
    </header>

    <div class="px-5 pt-2 shrink-0 border-b border-slate-800">
        <div class="flex">
            <button onclick="switchView('dashboard')" id="tab-dashboard" class="tab-btn active flex-1 py-3 text-sm font-medium transition-all">Dashboard</button>
            <button onclick="switchView('contacts')" id="tab-contacts" class="tab-btn flex-1 py-3 text-sm font-medium transition-all">Network</button>
        </div>
    </div>

    <main class="flex-1 overflow-y-auto p-5 pb-24 hide-scroll relative">

        <div id="view-dashboard" class="space-y-6 animate-fade-in">
            <div class="grid grid-cols-2 gap-3">
                <div class="glass-panel p-4 rounded-2xl">
                    <div class="flex items-center gap-2 mb-1"><span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span><span class="text-[10px] text-slate-400 font-bold uppercase">Overdue</span></div>
                    <p class="text-2xl font-bold text-white" id="stat-overdue">0</p>
                </div>
                <div class="glass-panel p-4 rounded-2xl">
                    <div class="flex items-center gap-2 mb-1"><span class="w-2 h-2 rounded-full bg-emerald-500"></span><span class="text-[10px] text-slate-400 font-bold uppercase">Active</span></div>
                    <p class="text-2xl font-bold text-white" id="stat-total">0</p>
                </div>
            </div>

            <div>
                <h2 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-3">Attention Needed</h2>
                <div id="urgent-list" class="space-y-3"></div>
            </div>

            <div>
                <h2 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-3">Up Next</h2>
                <div id="upcoming-list" class="space-y-3"></div>
            </div>
        </div>

        <div id="view-contacts" class="hidden space-y-4">
            <input type="text" id="search-input" onkeyup="renderContacts()" placeholder="Search contacts..." class="glass-input w-full px-4 py-3 text-sm">
            <div id="contacts-list" class="space-y-2"></div>
        </div>

    </main>

    <div id="profile-view" class="fixed inset-0 bg-[#020617] z-40 hidden flex flex-col animate-slide-up">
        <div class="h-16 flex items-center justify-between px-5 border-b border-slate-800 shrink-0">
            <button onclick="closeProfile()" class="text-slate-400 flex items-center gap-1"><i class="ph ph-caret-left text-lg"></i> Back</button>
            <div class="flex gap-4">
                <button onclick="deleteContact()" class="text-red-400"><i class="ph ph-trash text-xl"></i></button>
                <button onclick="editCurrentContact()" class="text-indigo-400"><i class="ph ph-pencil-simple text-xl"></i></button>
            </div>
        </div>
        
        <div class="flex-1 overflow-y-auto p-6">
            <div class="flex flex-col items-center mb-8">
                <div id="p-avatar" class="w-24 h-24 rounded-full bg-slate-800 flex items-center justify-center text-3xl font-bold text-slate-400 mb-4 border-2 border-slate-700"></div>
                <h2 id="p-name" class="text-2xl font-bold text-white"></h2>
                <span id="p-role" class="text-sm text-indigo-400 bg-indigo-500/10 px-3 py-1 rounded-full mt-2 border border-indigo-500/20"></span>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-8">
                <button onclick="openLogModal()" class="py-3 bg-white text-black rounded-xl font-bold text-sm flex items-center justify-center gap-2"><i class="ph ph-chat-circle-text text-lg"></i> Log Interaction</button>
                <div class="py-3 bg-slate-800 rounded-xl text-center border border-slate-700">
                    <span class="block text-[10px] text-slate-500 uppercase">Frequency</span>
                    <span class="font-bold text-slate-300" id="p-freq"></span>
                </div>
            </div>

            <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Interaction History</h3>
            <div id="p-history" class="space-y-6 border-l-2 border-slate-800 pl-6 ml-2 relative"></div>
        </div>
    </div>

    <div id="edit-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm hidden z-50 flex items-center justify-center p-6">
        <div class="bg-slate-900 w-full max-w-sm rounded-3xl border border-slate-800 p-6 shadow-2xl">
            <h3 class="font-bold text-lg text-white mb-4" id="modal-title">Add Contact</h3>
            <input type="hidden" id="inp-id">
            <div class="space-y-3">
                <input type="text" id="inp-name" class="glass-input w-full px-4 py-3" placeholder="Name">
                <div class="grid grid-cols-2 gap-2">
                    <input type="text" id="inp-role" class="glass-input w-full px-4 py-3" placeholder="Role (e.g. Client)">
                    <select id="inp-freq" class="glass-input w-full px-4 py-3 bg-slate-900">
                        <option value="7">Weekly</option>
                        <option value="14">Bi-Weekly</option>
                        <option value="30">Monthly</option>
                        <option value="90">Quarterly</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs text-slate-500 ml-1">Last Contacted</label>
                    <input type="date" id="inp-last" class="glass-input w-full px-4 py-3">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeEditModal()" class="flex-1 py-3 bg-slate-800 rounded-xl text-slate-400">Cancel</button>
                <button onclick="saveContact()" class="flex-1 py-3 bg-indigo-600 rounded-xl text-white font-bold">Save</button>
            </div>
        </div>
    </div>

    <div id="log-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm hidden z-50 flex items-center justify-center p-6">
        <div class="bg-slate-900 w-full max-w-sm rounded-3xl border border-slate-800 p-6 shadow-2xl">
            <h3 class="font-bold text-lg text-white mb-4">Log Interaction</h3>
            <textarea id="log-note" class="glass-input w-full h-24 px-4 py-3 mb-3 resize-none" placeholder="What did you discuss?"></textarea>
            <input type="date" id="log-date" class="glass-input w-full px-4 py-3 mb-4">
            <div class="flex gap-3">
                <button onclick="document.getElementById('log-modal').classList.add('hidden')" class="flex-1 py-3 bg-slate-800 rounded-xl text-slate-400">Cancel</button>
                <button onclick="saveLog()" class="flex-1 py-3 bg-emerald-600 rounded-xl text-white font-bold">Log It</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA & STATE ---
        let contacts = JSON.parse(localStorage.getItem('crm_contacts')) || [
            { id: 1, name: "Sarah Miller", role: "Mentor", freq: 30, last: "2023-11-01", logs: [{date:"2023-11-01", note:"Discussed career path"}] },
            { id: 2, name: "David Chen", role: "Client", freq: 14, last: new Date().toISOString().split('T')[0], logs: [] }
        ];
        let currentContactId = null;

        function init() {
            renderDashboard();
            renderContacts();
            document.getElementById('log-date').value = new Date().toISOString().split('T')[0];
        }

        // --- DASHBOARD ---
        function renderDashboard() {
            const now = moment();
            const urgentList = [];
            const upcomingList = [];

            contacts.forEach(c => {
                const nextDue = moment(c.last).add(c.freq, 'days');
                const diff = nextDue.diff(now, 'days');
                c.nextDueDiff = diff; // Store for sorting

                if (diff < 0) urgentList.push(c);
                else upcomingList.push(c);
            });

            // Stats
            document.getElementById('stat-overdue').innerText = urgentList.length;
            document.getElementById('stat-total').innerText = contacts.length;

            // Render Urgent
            const urgentContainer = document.getElementById('urgent-list');
            urgentContainer.innerHTML = urgentList.length === 0 ? `<div class="p-4 bg-slate-800/30 rounded-xl text-center text-xs text-slate-500">All caught up! ðŸŽ‰</div>` : '';
            urgentList.forEach(c => urgentContainer.appendChild(createContactCard(c, true)));

            // Render Upcoming (Sorted)
            const upcomingContainer = document.getElementById('upcoming-list');
            upcomingContainer.innerHTML = '';
            upcomingList.sort((a,b) => a.nextDueDiff - b.nextDueDiff).slice(0, 5).forEach(c => upcomingContainer.appendChild(createContactCard(c, false)));
        }

        function createContactCard(c, isUrgent) {
            const div = document.createElement('div');
            const daysText = isUrgent ? `${Math.abs(c.nextDueDiff)} days overdue` : `Due in ${c.nextDueDiff} days`;
            const colorClass = isUrgent ? 'text-red-400' : 'text-slate-400';
            
            div.className = "flex items-center justify-between p-4 bg-slate-800/50 border border-slate-700/50 rounded-xl cursor-pointer active:bg-slate-800";
            div.onclick = () => openProfile(c.id);
            div.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-white font-bold text-sm">${c.name.substring(0,2).toUpperCase()}</div>
                    <div><h4 class="font-bold text-sm text-white">${c.name}</h4><p class="text-[10px] ${colorClass}">${daysText}</p></div>
                </div>
                <i class="ph ph-caret-right text-slate-600"></i>
            `;
            return div;
        }

        // --- CONTACTS LIST ---
        function renderContacts() {
            const q = document.getElementById('search-input').value.toLowerCase();
            const container = document.getElementById('contacts-list');
            container.innerHTML = '';
            
            contacts.filter(c => c.name.toLowerCase().includes(q)).sort((a,b) => a.name.localeCompare(b.name)).forEach(c => {
                const div = document.createElement('div');
                div.className = "flex items-center gap-4 p-4 bg-slate-800/30 border border-slate-700/30 rounded-xl cursor-pointer";
                div.onclick = () => openProfile(c.id);
                div.innerHTML = `
                    <div class="w-10 h-10 rounded-full bg-indigo-500/20 text-indigo-300 flex items-center justify-center font-bold text-sm">${c.name.substring(0,2).toUpperCase()}</div>
                    <div class="flex-1"><h3 class="font-bold text-white text-sm">${c.name}</h3><p class="text-xs text-slate-500">${c.role}</p></div>
                `;
                container.appendChild(div);
            });
        }

        // --- PROFILE VIEW ---
        function openProfile(id) {
            currentContactId = id;
            const c = contacts.find(x => x.id === id);
            if(!c) return;

            document.getElementById('p-avatar').innerText = c.name.substring(0,2).toUpperCase();
            document.getElementById('p-name').innerText = c.name;
            document.getElementById('p-role').innerText = c.role;
            document.getElementById('p-freq').innerText = `Every ${c.freq} days`;
            
            const historyContainer = document.getElementById('p-history');
            historyContainer.innerHTML = '';
            
            // Add Logs
            const logs = c.logs || [];
            // Add implicit "Last Contacted" log if logs are empty but last date exists
            if(logs.length === 0 && c.last) logs.push({date: c.last, note: "Contact updated"});

            logs.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(log => {
                const item = document.createElement('div');
                item.className = "relative";
                item.innerHTML = `
                    <div class="absolute -left-[31px] top-1 w-4 h-4 rounded-full bg-slate-900 border-2 border-indigo-500"></div>
                    <p class="text-xs text-indigo-400 font-bold mb-1">${moment(log.date).format('MMM D, YYYY')}</p>
                    <p class="text-sm text-slate-300 bg-slate-800/50 p-3 rounded-lg border border-slate-700/50">${log.note}</p>
                `;
                historyContainer.appendChild(item);
            });

            document.getElementById('profile-view').classList.remove('hidden');
        }

        function closeProfile() { document.getElementById('profile-view').classList.add('hidden'); currentContactId = null; }

        // --- LOGGING ---
        function openLogModal() { document.getElementById('log-modal').classList.remove('hidden'); document.getElementById('log-note').value = ''; }
        
        function saveLog() {
            const note = document.getElementById('log-note').value;
            const date = document.getElementById('log-date').value;
            if(!note) return alert("Write a note!");

            const idx = contacts.findIndex(c => c.id === currentContactId);
            if(idx !== -1) {
                if(!contacts[idx].logs) contacts[idx].logs = [];
                contacts[idx].logs.unshift({ date, note });
                contacts[idx].last = date; // Update main last contacted date
                localStorage.setItem('crm_contacts', JSON.stringify(contacts));
                
                document.getElementById('log-modal').classList.add('hidden');
                openProfile(currentContactId); // Refresh profile
                renderDashboard(); // Refresh dashboard
                renderContacts();
            }
        }

        // --- EDITING ---
        function openEditModal() { 
            document.getElementById('edit-modal').classList.remove('hidden'); 
            document.getElementById('modal-title').innerText = "Add Contact";
            document.getElementById('inp-id').value = "";
            document.getElementById('inp-name').value = "";
            document.getElementById('inp-role').value = "";
            document.getElementById('inp-last').value = new Date().toISOString().split('T')[0];
        }
        
        function editCurrentContact() {
            const c = contacts.find(x => x.id === currentContactId);
            openEditModal();
            document.getElementById('modal-title').innerText = "Edit Contact";
            document.getElementById('inp-id').value = c.id;
            document.getElementById('inp-name').value = c.name;
            document.getElementById('inp-role').value = c.role;
            document.getElementById('inp-freq').value = c.freq;
            document.getElementById('inp-last').value = c.last;
        }

        function closeEditModal() { document.getElementById('edit-modal').classList.add('hidden'); }

        function saveContact() {
            const id = document.getElementById('inp-id').value;
            const name = document.getElementById('inp-name').value;
            const role = document.getElementById('inp-role').value;
            const freq = parseInt(document.getElementById('inp-freq').value);
            const last = document.getElementById('inp-last').value;

            if(!name) return alert("Name required");

            if(id) {
                // Edit existing
                const idx = contacts.findIndex(c => c.id == id);
                if(idx !== -1) {
                    contacts[idx] = { ...contacts[idx], name, role, freq, last };
                }
            } else {
                // Add new
                contacts.push({ id: Date.now(), name, role, freq, last, logs: [] });
            }

            localStorage.setItem('crm_contacts', JSON.stringify(contacts));
            closeEditModal();
            init();
            if(currentContactId && id == currentContactId) openProfile(currentContactId); // Refresh if editing open profile
        }

        function deleteContact() {
            if(confirm("Delete this contact?")) {
                contacts = contacts.filter(c => c.id !== currentContactId);
                localStorage.setItem('crm_contacts', JSON.stringify(contacts));
                closeProfile();
                init();
            }
        }

        function switchView(v) {
            ['dashboard','contacts'].forEach(i => {
                document.getElementById(`view-${i}`).classList.add('hidden');
                document.getElementById(`tab-${i}`).classList.remove('active');
            });
            document.getElementById(`view-${v}`).classList.remove('hidden');
            document.getElementById(`tab-${v}`).classList.add('active');
        }

        init();
    </script>
</body>
</html>