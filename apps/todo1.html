<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Task Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
                    colors: { 
                        task: { 
                            bg: '#F6F6F6', 
                            purple: '#6B5AE0',
                            text: '#1B1B1B',
                            muted: '#94A3B8',
                        } 
                    },
                    boxShadow: {
                        'glow': '0 8px 25px rgba(107, 90, 224, 0.35)',
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #F6F6F6; color: #1B1B1B; -webkit-tap-highlight-color: transparent; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        
        /* Interactive Elements */
        .status-btn { transition: transform 0.1s; cursor: pointer; }
        .status-btn:active { transform: scale(0.9); }
        
        /* Badges */
        .badge-prio { padding: 4px 10px; border-radius: 8px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
        .prio-high { background: #FEE2E2; color: #EF4444; }
        .prio-med { background: #FEF3C7; color: #F59E0B; }
        .prio-low { background: #ECFCCB; color: #84CC16; }
        .badge-date { font-size: 11px; font-weight: 600; color: #94A3B8; display: flex; align-items: center; gap: 4px; }
        .badge-overdue { background: #FECACA; color: #DC2626; padding: 2px 8px; border-radius: 6px; font-size: 10px; font-weight: 800; text-transform: uppercase; }
        .badge-today { background: #E0E7FF; color: #4F46E5; padding: 2px 8px; border-radius: 6px; font-size: 10px; font-weight: 800; text-transform: uppercase; }
        .badge-subtask { font-size: 10px; font-weight: 700; color: #64748B; background: #F1F5F9; padding: 4px 8px; border-radius: 8px; display: flex; align-items: center; gap: 4px; }

        /* Components */
        .date-card { width: 60px; height: 85px; border-radius: 22px; background: white; display: flex; flex-direction: column; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.2s; position: relative; }
        .date-card.active { background: #6B5AE0; color: white; box-shadow: 0 8px 20px rgba(107, 90, 224, 0.3); transform: translateY(-2px); }
        .date-card.active span { color: white !important; }
        .date-dot { width: 6px; height: 6px; background: #6B5AE0; border-radius: 50%; position: absolute; bottom: 8px; }
        .date-card.active .date-dot { background: white; }
        
        .all-card { width: 60px; height: 85px; border-radius: 22px; background: white; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-weight: 800; color: #94A3B8; transition: all 0.2s; }
        .all-card.active { background: #1B1B1B; color: white; box-shadow: 0 8px 20px rgba(0,0,0,0.2); transform: translateY(-2px); }

        .task-item { border-radius: 24px; padding: 20px; position: relative; transition: all 0.2s ease-in-out; touch-action: manipulation; }
        .task-item:active { transform: scale(0.98); }
        .task-item.done { background-color: #E2E8F0; border: 1px solid #CBD5E1; box-shadow: none; }
        .task-item.active-task { background-color: white; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
        
        /* Ghost element when dragging */
        .sortable-ghost { opacity: 0.4; background: #F1F5F9; border: 2px dashed #94A3B8; transform: scale(0.95); }
        .sortable-drag { cursor: grabbing; opacity: 1; background: white; box-shadow: 0 10px 25px rgba(0,0,0,0.1); transform: scale(1.02); }

        .delete-btn { position: absolute; top: 16px; right: 16px; width: 30px; height: 30px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #EF4444; background: #FEF2F2; opacity: 0; transition: opacity 0.2s; z-index: 10; }
        .task-item:hover .delete-btn { opacity: 1; }

        .project-card { background: white; padding: 20px; border-radius: 24px; box-shadow: 0 2px 10px rgba(0,0,0,0.02); transition: transform 0.1s; display: flex; flex-direction: column; justify-content: space-between; height: 140px; }
        .project-card:active { transform: scale(0.97); }
        .project-add-card { border: 2px dashed #E2E8F0; background: transparent; justify-content: center; align-items: center; color: #94A3B8; }

        .subtask-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: #F9F9F9; border-radius: 12px; margin-bottom: 8px; }
        .checkbox { width: 20px; height: 20px; border: 2px solid #6B5AE0; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; transition: all 0.2s; }
        .checkbox.checked { background: #6B5AE0; }
        .subtask-text.checked { text-decoration: line-through; color: #94A3B8; }

        /* Detail View Editing Styles */
        .editable-input { background: transparent; border: 1px solid transparent; transition: all 0.2s; border-radius: 8px; }
        .is-editing .editable-input { background: #F8FAFC; border-color: #E2E8F0; padding: 4px 8px; }
        .is-editing .editable-input:focus { border-color: #6B5AE0; background: white; }
        
        .subtask-controls { display: none; }
        .is-editing .subtask-controls { display: flex; }
        .is-editing .subtask-delete { display: block !important; }

        /* Nav Bar */
        .nav-bar { background: white; border-top-left-radius: 35px; border-top-right-radius: 35px; box-shadow: 0 -5px 40px rgba(0,0,0,0.05); position: fixed; bottom: 0; width: 100%; z-index: 50; }
        .fab { width: 64px; height: 64px; background: #6B5AE0; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 32px; box-shadow: 0 8px 25px rgba(107, 90, 224, 0.4); position: absolute; top: -35px; left: 50%; transform: translateX(-50%); }
        .nav-icon { font-size: 28px; color: #94A3B8; padding: 12px; transition: color 0.2s; }
        .nav-icon.active { color: #6B5AE0; }

        .slide-up { animation: slideUp 0.3s ease-out forwards; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .slide-in-right { animation: slideRight 0.3s ease-out forwards; }
        @keyframes slideRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
    </style>
</head>
<body class="h-screen flex flex-col bg-task-bg overflow-hidden">

    <div id="main-container" class="flex-1 w-full relative overflow-hidden">
        
        <div id="view-home" class="view-section flex flex-col h-full">
            <header class="px-6 pt-8 pb-2 shrink-0">
                <div class="flex items-center justify-between mb-6">
                    <button onclick="window.parent.goBack()" class="w-10 h-10 flex items-center justify-center text-task-text"><i class="ph-bold ph-caret-left text-2xl"></i></button>
                    <h1 class="text-xl font-bold">My Tasks</h1>
                    <div class="w-10 h-10 flex items-center justify-center relative"><i class="ph-fill ph-bell text-2xl text-task-text"></i><div class="absolute top-2 right-2.5 w-2 h-2 bg-red-500 rounded-full border border-task-bg"></div></div>
                </div>
                <div class="flex gap-3 overflow-x-auto hide-scroll pb-6 px-1" id="calendar-strip"></div>
            </header>
            <main class="flex-1 overflow-y-auto hide-scroll px-6 pb-32">
                <div class="flex gap-3 mb-6 overflow-x-auto hide-scroll pb-2 items-center">
                    <button onclick="setFilter('all')" class="px-5 py-2.5 rounded-2xl font-bold text-sm bg-task-purple text-white shadow-lg transition-all flex-shrink-0" id="tab-all">All</button>
                    <button onclick="setFilter('todo')" class="px-5 py-2.5 rounded-2xl font-bold text-sm bg-white text-gray-400 transition-all flex-shrink-0" id="tab-todo">To do</button>
                    <button onclick="setFilter('progress')" class="px-5 py-2.5 rounded-2xl font-bold text-sm bg-white text-gray-400 transition-all flex-shrink-0" id="tab-progress">In Progress</button>
                    <button onclick="setFilter('done')" class="px-5 py-2.5 rounded-2xl font-bold text-sm bg-white text-gray-400 transition-all flex-shrink-0" id="tab-done">Done</button>
                    <button onclick="toggleAllGroups()" class="px-5 py-2.5 rounded-2xl font-bold text-sm bg-gray-800 text-white shadow-md transition-all flex-shrink-0 ml-auto" id="btn-toggle-all">Expand All</button>
                </div>
                <div id="overdue-container" class="hidden mb-6"><h3 class="text-xs font-bold text-red-500 uppercase tracking-wide mb-2">Overdue</h3><div id="overdue-list" class="space-y-4"></div></div>
                <div id="task-list" class="space-y-6"></div>
                <div id="empty-state" class="hidden flex-col items-center justify-center py-10 opacity-40"><i class="ph-fill ph-clipboard-text text-6xl text-task-muted mb-2"></i><p class="text-sm font-bold text-task-muted">No tasks found</p></div>
            </main>
        </div>

        <div id="view-calendar" class="view-section hidden flex flex-col h-full">
            <main class="flex-1 overflow-y-auto hide-scroll px-6 pt-8 pb-32">
                <h1 class="text-2xl font-bold mb-6">Calendar</h1>
                <div class="bg-white rounded-[30px] p-6 shadow-sm mb-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="font-bold text-lg" id="cal-month-name">Month</h2>
                        <div class="flex gap-2"><button onclick="changeMonth(-1)" class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center"><i class="ph-bold ph-caret-left"></i></button><button onclick="changeMonth(1)" class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center"><i class="ph-bold ph-caret-right"></i></button></div>
                    </div>
                    <div class="grid grid-cols-7 gap-2 text-center text-xs font-bold text-gray-400 mb-2"><div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div></div>
                    <div id="month-grid" class="grid grid-cols-7 gap-2 text-center"></div>
                </div>
                <div id="calendar-tasks" class="space-y-3"></div>
            </main>
        </div>

        <div id="view-projects" class="view-section hidden flex flex-col h-full">
             <main class="flex-1 overflow-y-auto hide-scroll px-6 pt-8 pb-32">
                <h1 class="text-2xl font-bold mb-6">Task Groups</h1>
                <div id="projects-grid" class="grid grid-cols-2 gap-4"></div>
            </main>
        </div>

        <div id="view-profile" class="view-section hidden flex flex-col h-full">
            <main class="flex-1 overflow-y-auto hide-scroll px-6 pt-8 pb-32">
                <h1 class="text-2xl font-bold mb-6">Profile</h1>
                <div class="bg-white p-6 rounded-[30px] shadow-sm flex items-center gap-5 mb-6">
                    <div class="w-16 h-16 rounded-full bg-task-purple flex items-center justify-center text-white text-2xl font-bold shadow-lg">J</div>
                    <div><h2 class="font-bold text-xl">Josh</h2><p class="text-xs text-gray-400 font-medium">Keep moving forward!</p></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-task-purple p-6 rounded-[24px] text-white shadow-glow"><h3 class="text-xs opacity-70 uppercase font-bold mb-1">Completed</h3><p class="text-4xl font-bold" id="stat-completed">0</p></div>
                    <div class="bg-white p-6 rounded-[24px] text-task-text shadow-sm border border-gray-100"><h3 class="text-xs text-gray-400 uppercase font-bold mb-1">Pending</h3><p class="text-4xl font-bold" id="stat-pending">0</p></div>
                </div>
            </main>
        </div>

        <div id="view-project-detail" class="hidden fixed inset-0 bg-task-bg z-[2000] flex flex-col h-[100dvh] slide-in-right">
            <div class="px-6 pt-8 pb-4 flex items-center justify-between shrink-0 bg-task-bg/95 backdrop-blur-sm z-10">
                <div class="flex items-center gap-4">
                    <button onclick="closeGroupDetail()" class="w-10 h-10 rounded-full bg-white shadow-sm flex items-center justify-center text-task-text"><i class="ph-bold ph-caret-left text-xl"></i></button>
                    <h1 class="text-xl font-bold" id="detail-title">Group</h1>
                </div>
                <button onclick="openAddViewFromProject()" class="px-4 py-2 bg-task-purple text-white rounded-xl text-xs font-bold shadow-glow">+ Add Task</button>
            </div>
            <div class="flex-1 overflow-y-auto hide-scroll px-6 pb-40 space-y-4">
                <div class="min-h-[100px] p-2" id="detail-list-todo" data-status="todo"></div>
                <div class="min-h-[100px] p-2" id="detail-list-progress" data-status="progress"></div>
                <div class="min-h-[100px] p-2" id="detail-list-done" data-status="done"></div>
            </div>
        </div>

        <div id="view-task-detail" class="hidden fixed inset-0 bg-task-bg z-[2000] flex flex-col h-[100dvh] slide-in-right">
            <div class="px-6 pt-8 pb-4 flex items-center justify-between shrink-0">
                <button onclick="closeTaskDetail()" class="w-10 h-10 rounded-full bg-white shadow-sm flex items-center justify-center text-task-text"><i class="ph-bold ph-caret-left text-xl"></i></button>
                <div class="flex gap-2">
                    <button onclick="toggleEditMode()" id="btn-edit-toggle" class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-500"><i class="ph-bold ph-pencil-simple text-xl"></i></button>
                    <button onclick="deleteOpenTask()" class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center text-red-500"><i class="ph-bold ph-trash text-xl"></i></button>
                </div>
            </div>
            <div id="task-detail-content" class="flex-1 overflow-y-auto hide-scroll px-6 pb-40">
                <div class="bg-white rounded-[30px] p-6 shadow-sm mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <div class="relative">
                            <select id="td-group-select" onchange="updateTaskField('group', this.value)" class="editable-input appearance-none text-xs font-bold uppercase tracking-wider text-gray-400 outline-none pr-4" disabled></select>
                            <i class="ph-bold ph-caret-down absolute right-0 top-0.5 text-xs text-gray-400 pointer-events-none opacity-0 transition-opacity" id="td-group-icon"></i>
                        </div>
                        <select id="td-prio-select" onchange="updateTaskField('priority', this.value)" class="editable-input appearance-none badge-prio font-bold outline-none text-center border-none cursor-pointer" disabled>
                            <option value="High">HIGH</option>
                            <option value="Medium">MED</option>
                            <option value="Low">LOW</option>
                        </select>
                    </div>
                    <input id="td-title-input" type="text" class="editable-input text-2xl font-bold mb-2 leading-tight w-full outline-none text-task-text placeholder-gray-300" onchange="updateTaskField('title', this.value)" readonly>
                    <textarea id="td-desc-input" class="editable-input text-gray-500 text-sm leading-relaxed mb-4 w-full outline-none resize-none h-20 placeholder-gray-300" placeholder="Add description..." onchange="updateTaskField('description', this.value)" readonly></textarea>
                    <div class="flex items-center gap-2 mb-6 p-2 rounded-xl w-fit border border-transparent transition-colors" id="td-date-wrapper">
                        <i class="ph-fill ph-calendar text-task-purple text-lg"></i>
                        <input type="date" id="td-date-input" class="font-bold text-sm bg-transparent outline-none text-task-text" onchange="updateTaskField('date', this.value)" disabled>
                    </div>
                    <div class="flex bg-gray-100 p-1 rounded-xl mb-6">
                        <button onclick="updateTaskStatus('todo')" id="btn-stat-todo" class="flex-1 py-2 rounded-lg text-xs font-bold text-gray-500">To Do</button>
                        <button onclick="updateTaskStatus('progress')" id="btn-stat-progress" class="flex-1 py-2 rounded-lg text-xs font-bold text-gray-500">In Progress</button>
                        <button onclick="updateTaskStatus('done')" id="btn-stat-done" class="flex-1 py-2 rounded-lg text-xs font-bold text-gray-500">Done</button>
                    </div>
                </div>
                <div class="mb-6">
                    <h3 class="text-sm font-bold uppercase text-gray-400 mb-3">Sub-Tasks</h3>
                    <div id="subtask-list"></div>
                    <div class="flex gap-2 mt-3 subtask-controls">
                        <input id="new-subtask" type="text" placeholder="Add a step..." class="flex-1 bg-white px-4 py-3 rounded-xl text-sm font-bold outline-none shadow-sm">
                        <button onclick="addSubTask()" class="w-12 h-12 bg-task-purple text-white rounded-xl shadow-glow flex items-center justify-center"><i class="ph-bold ph-plus"></i></button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="view-add-project" class="hidden fixed inset-0 bg-black/50 z-[3000] flex items-center justify-center p-6 fade-in">
            <div class="bg-white w-full max-w-sm rounded-[30px] p-6 shadow-2xl">
                <h3 class="text-xl font-bold mb-4">New Project</h3>
                <input id="inp-new-project" class="w-full bg-gray-100 rounded-xl px-4 py-3 font-bold text-task-text outline-none mb-6" placeholder="Project Name">
                <div class="flex gap-3">
                    <button onclick="document.getElementById('view-add-project').classList.add('hidden')" class="flex-1 py-3 bg-gray-200 rounded-xl font-bold text-gray-600">Cancel</button>
                    <button onclick="saveNewProject()" class="flex-1 py-3 bg-task-purple text-white rounded-xl font-bold shadow-glow">Create</button>
                </div>
            </div>
        </div>

    </div>

    <nav class="nav-bar h-[90px] flex justify-between items-center px-8">
        <button onclick="switchTab('home')" class="nav-icon active" id="nav-home"><i class="ph-fill ph-house"></i></button>
        <button onclick="switchTab('calendar')" class="nav-icon" id="nav-calendar"><i class="ph-fill ph-calendar-blank"></i></button>
        <div class="relative w-16"><div class="fab-container"><button onclick="openAddView()" class="fab active:scale-95 transition-transform"><i class="ph-bold ph-plus"></i></button></div></div>
        <button onclick="switchTab('projects')" class="nav-icon" id="nav-projects"><i class="ph-fill ph-files"></i></button>
        <button onclick="switchTab('profile')" class="nav-icon" id="nav-profile"><i class="ph-fill ph-user"></i></button>
    </nav>

    <div id="view-add" class="hidden fixed inset-0 bg-task-bg z-[3000] flex flex-col h-[100dvh] slide-up">
        <div class="px-6 pt-8 pb-4 flex items-center justify-between shrink-0">
            <button onclick="closeAddView()" class="w-10 h-10 flex items-center justify-center text-task-text"><i class="ph-bold ph-caret-left text-xl"></i></button>
            <h1 class="text-xl font-bold">Add Task</h1>
            <div class="w-10"></div>
        </div>
        <div class="flex-1 overflow-y-auto px-6 pb-40 space-y-4">
            <div class="bg-white rounded-[20px] p-4 flex items-center justify-between shadow-sm">
                <div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-pink-100 flex items-center justify-center text-pink-500"><i class="ph-fill ph-briefcase text-xl"></i></div>
                <div class="flex-1"><label class="text-[10px] text-gray-400 font-bold uppercase block">Group</label><select id="inp-group" class="bg-transparent w-full font-bold outline-none"></select></div></div>
            </div>
            <div class="bg-white rounded-[20px] p-4 shadow-sm"><label class="text-[10px] text-gray-400 font-bold uppercase block mb-1">Title</label><input type="text" id="inp-title" placeholder="e.g. Design Sprint" class="w-full font-bold text-lg outline-none bg-transparent"></div>
            <div class="bg-white rounded-[20px] p-4 shadow-sm"><label class="text-[10px] text-gray-400 font-bold uppercase block mb-1">Description</label><textarea id="inp-desc" placeholder="Details..." class="w-full font-medium text-sm outline-none bg-transparent resize-none" rows="3"></textarea></div>
            <div class="flex gap-4">
                <div class="bg-white rounded-[20px] p-4 shadow-sm flex-1"><label class="text-[10px] text-gray-400 font-bold uppercase block mb-1">Date</label><input type="date" id="inp-date" class="w-full font-bold text-sm outline-none bg-transparent"></div>
                <div class="bg-white rounded-[20px] p-4 shadow-sm flex-1"><label class="text-[10px] text-gray-400 font-bold uppercase block mb-1">Priority</label><select id="inp-priority" class="w-full font-bold text-sm outline-none bg-transparent"><option value="High">High</option><option value="Medium" selected>Medium</option><option value="Low">Low</option></select></div>
            </div>
            <div class="bg-white rounded-[20px] p-4 shadow-sm">
                <label class="text-[10px] text-gray-400 font-bold uppercase block mb-2">Sub-Tasks</label>
                <div id="temp-subtask-list" class="space-y-2 mb-3"></div>
                <div class="flex gap-2">
                    <input id="inp-temp-subtask" type="text" placeholder="Add step..." class="flex-1 bg-gray-50 px-3 py-2 rounded-xl text-sm font-bold outline-none border border-gray-100">
                    <button onclick="addTempSubtask()" class="w-10 h-10 bg-task-purple text-white rounded-xl flex items-center justify-center shadow-sm"><i class="ph-bold ph-plus"></i></button>
                </div>
            </div>
        </div>
        <div class="absolute bottom-8 left-0 w-full px-6"><button onclick="saveTask()" class="w-full py-4 bg-task-purple text-white rounded-[20px] font-bold shadow-glow text-lg active:scale-95 transition-transform">Create Task</button></div>
    </div>

    <script>
        // --- DATA STORE ---
        let tasks = JSON.parse(localStorage.getItem('tm_tasks')) || [];
        let projects = JSON.parse(localStorage.getItem('tm_projects')) || ['Work', 'Personal', 'Study'];
        let selectedDate = new Date().toISOString().split('T')[0];
        let currentFilter = 'all';
        let displayMonth = new Date();
        let currentViewingGroup = null;
        let activeTaskId = null;
        let tempSubtasks = [];
        let isEditing = false;
        let globalExpandState = false;

        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const shortMonths = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

        function init() {
            renderDateStrip(); renderTasks(); updateStats(); renderCalendarGrid(); renderProjects();
            document.getElementById('inp-date').value = selectedDate;
        }

        // --- NAVIGATION ---
        function switchTab(tab) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-icon').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            document.getElementById(`nav-${tab}`).classList.add('active');
            document.getElementById('view-project-detail').classList.add('hidden');
            document.getElementById('view-task-detail').classList.add('hidden');
            if(tab==='calendar') { renderCalendarGrid(); renderCalendarList(); }
            if(tab==='projects') { renderProjects(); updateStats(); }
            if(tab==='profile') updateStats();
        }

        // --- HOME VIEW ---
        function renderDateStrip() {
            const c = document.getElementById('calendar-strip'); c.innerHTML = '';
            const isAll = selectedDate === 'ALL';
            c.innerHTML += `<div onclick="selectDate('ALL')" class="all-card cursor-pointer ${isAll ? 'active' : ''}">ALL</div>`;
            const t = new Date();
            for(let i=-2; i<8; i++){
                const d = new Date(); d.setDate(t.getDate()+i);
                const s = d.toISOString().split('T')[0];
                const active = s===selectedDate ? 'active' : '';
                const txt = s===selectedDate ? 'text-white' : 'text-gray-400';
                const hasTask = tasks.some(t => t.date === s && t.status !== 'done');
                let dotHTML = hasTask ? '<div class="date-dot"></div>' : '';
                c.innerHTML += `<div onclick="selectDate('${s}')" class="date-card cursor-pointer ${active}"><span class="text-[10px] font-bold mb-1 ${txt}">${shortMonths[d.getMonth()]}</span><span class="text-xl font-bold ${txt}">${d.getDate()}</span><span class="text-[10px] font-semibold mt-1 ${txt}">${dayNames[d.getDay()]}</span>${dotHTML}</div>`;
            }
        }
        
        function selectDate(s) { 
            selectedDate=s; 
            globalExpandState = false; 
            updateToggleButton();
            renderDateStrip(); 
            renderTasks(); 
        }
        
        function renderTasks() {
            const c = document.getElementById('task-list'); c.innerHTML = '';
            let filteredTasks = [];
            
            if(selectedDate === 'ALL') {
                filteredTasks = tasks.filter(t => currentFilter === 'all' || t.status === currentFilter);
                filteredTasks.sort((a,b) => new Date(a.date) - new Date(b.date));
            } else {
                filteredTasks = tasks.filter(t => t.date === selectedDate && (currentFilter==='all' || t.status===currentFilter));
            }

            if(filteredTasks.length === 0) document.getElementById('empty-state').classList.remove('hidden');
            else {
                document.getElementById('empty-state').classList.add('hidden');
                const groups = {};
                filteredTasks.forEach(t => { if(!groups[t.group]) groups[t.group] = []; groups[t.group].push(t); });
                
                Object.keys(groups).sort().forEach(groupName => {
                    const safeId = groupName.replace(/[^a-zA-Z0-9]/g, '-');
                    const count = groups[groupName].filter(t => t.status !== 'done').length;
                    const hiddenClass = globalExpandState ? '' : 'hidden';
                    const rotate = globalExpandState ? 'rotate(0deg)' : 'rotate(-90deg)';

                    c.innerHTML += `
                        <div class="mb-2">
                            <div onclick="toggleGroup('${safeId}')" class="flex items-center justify-between py-2 cursor-pointer select-none">
                                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wide flex items-center gap-2">
                                    <i id="icon-${safeId}" class="ph-bold ph-caret-down transition-transform duration-200" style="transform: ${rotate}"></i>
                                    ${groupName} <span class="text-task-purple">(${count})</span>
                                </h3>
                                <div class="h-px bg-gray-200 flex-1 ml-4"></div>
                            </div>
                            <div id="list-${safeId}" class="space-y-3 transition-all ${hiddenClass}">
                                ${groups[groupName].map(t => createTaskHTML(t)).join('')}
                            </div>
                        </div>`;
                });
            }
        }

        function toggleGroup(id) {
            const list = document.getElementById(`list-${id}`);
            const icon = document.getElementById(`icon-${id}`);
            if(list) list.classList.toggle('hidden');
            if(icon) {
                const isHidden = list.classList.contains('hidden');
                icon.style.transform = isHidden ? 'rotate(-90deg)' : 'rotate(0deg)';
            }
        }

        function toggleAllGroups() {
            globalExpandState = !globalExpandState;
            updateToggleButton();
            const lists = document.querySelectorAll('[id^="list-"]');
            const icons = document.querySelectorAll('[id^="icon-"]');
            lists.forEach(el => { if(globalExpandState) el.classList.remove('hidden'); else el.classList.add('hidden'); });
            icons.forEach(el => { el.style.transform = globalExpandState ? 'rotate(0deg)' : 'rotate(-90deg)'; });
        }

        function updateToggleButton() {
            const btn = document.getElementById('btn-toggle-all');
            btn.innerText = globalExpandState ? 'Collapse All' : 'Expand All';
        }

        function createTaskHTML(t) {
            const style = getProjectStyle(t.group);
            const todayStr = new Date().toISOString().split('T')[0];
            let dateBadge = '';
            if(t.date < todayStr && t.status !== 'done') dateBadge = `<span class="badge-overdue">OVERDUE</span>`;
            else if(t.date === todayStr) dateBadge = `<span class="badge-today">TODAY</span>`;
            else dateBadge = `<span class="badge-date"><i class="ph-bold ph-calendar"></i> ${t.date.slice(5)}</span>`;
            
            let prioClass = t.priority === 'High' ? 'prio-high' : (t.priority === 'Low' ? 'prio-low' : 'prio-med');
            let statusBtn = '';
            if(t.status === 'done') statusBtn = `<button onclick="toggleStatus(${t.id}, event)" class="status-btn text-[10px] bg-blue-100 text-blue-600 px-3 py-1.5 rounded-lg font-bold">Done</button>`;
            else if(t.status === 'progress') statusBtn = `<button onclick="toggleStatus(${t.id}, event)" class="status-btn text-[10px] bg-orange-100 text-orange-600 px-3 py-1.5 rounded-lg font-bold">In Progress</button>`;
            else statusBtn = `<button onclick="toggleStatus(${t.id}, event)" class="status-btn text-[10px] bg-gray-100 text-gray-500 px-3 py-1.5 rounded-lg font-bold">To Do</button>`;

            const isDoneClass = t.status === 'done' ? 'done' : 'active-task';
            const titleClass = t.status === 'done' ? 'line-through text-gray-400' : 'text-task-text';
            const totalSub = t.subtasks ? t.subtasks.length : 0;
            const doneSub = t.subtasks ? t.subtasks.filter(s => s.done).length : 0;
            let subtaskBadge = '';
            if (totalSub > 0) subtaskBadge = `<span class="badge-subtask"><i class="ph-bold ph-checks"></i> ${doneSub}/${totalSub}</span>`;

            return `
                <div class="task-item ${isDoneClass} flex flex-col cursor-pointer mb-3" data-id="${t.id}" onclick="openTaskDetail(${t.id})">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <p class="text-[10px] font-bold text-gray-400 uppercase mb-1">${t.group}</p>
                            <h3 class="font-bold text-lg leading-tight ${titleClass}">${t.title}</h3>
                        </div>
                        <div class="w-10 h-10 rounded-xl ${style.bg} ${style.text} flex items-center justify-center text-xl shrink-0"><i class="ph-fill ${style.icon}"></i></div>
                    </div>
                    <div class="flex justify-between items-center mt-2">
                        <div class="flex gap-2 items-center flex-wrap">${dateBadge} <span class="badge-prio ${prioClass}">${t.priority || 'MED'}</span> ${subtaskBadge}</div>
                        ${statusBtn}
                    </div>
                </div>`;
        }

        // --- PROJECTS ---
        function renderProjects() {
            const grid = document.getElementById('projects-grid');
            grid.innerHTML = '';
            projects.forEach(p => {
                const count = tasks.filter(t => t.group === p && t.status !== 'done').length;
                const style = getProjectStyle(p);
                grid.innerHTML += `<div onclick="openGroupDetail('${p}')" class="project-card cursor-pointer group"><div class="w-12 h-12 rounded-2xl ${style.bg} ${style.text} flex items-center justify-center mb-3 group-active:scale-90 transition-transform"><i class="ph-fill ${style.icon} text-2xl"></i></div><div><h3 class="font-bold text-lg truncate">${p}</h3><p class="text-xs text-gray-400 mt-1 font-semibold">${count} Active Tasks</p></div></div>`;
            });
            grid.innerHTML += `<div onclick="document.getElementById('view-add-project').classList.remove('hidden')" class="project-card project-add-card cursor-pointer group hover:border-task-purple hover:text-task-purple transition-colors"><div class="w-12 h-12 rounded-full bg-gray-100 flex items-center justify-center group-active:scale-90 transition-transform"><i class="ph-bold ph-plus text-2xl"></i></div><span class="font-bold text-sm">New Project</span></div>`;
        }
        function saveNewProject() {
            const name = document.getElementById('inp-new-project').value.trim();
            if(name && !projects.includes(name)) { projects.push(name); localStorage.setItem('tm_projects', JSON.stringify(projects)); renderProjects(); document.getElementById('inp-new-project').value = ''; document.getElementById('view-add-project').classList.add('hidden'); }
        }
        function getProjectStyle(name) {
            const styles = [{bg:'bg-pink-100',text:'text-pink-500',icon:'ph-briefcase'},{bg:'bg-purple-100',text:'text-task-purple',icon:'ph-user'},{bg:'bg-orange-100',text:'text-orange-500',icon:'ph-book-open-text'},{bg:'bg-blue-100',text:'text-blue-500',icon:'ph-rocket'},{bg:'bg-green-100',text:'text-green-500',icon:'ph-plant'},{bg:'bg-teal-100',text:'text-teal-500',icon:'ph-coffee'}];
            let hash=0; for(let i=0;i<name.length;i++)hash=name.charCodeAt(i)+((hash<<5)-hash);
            return styles[Math.abs(hash)%styles.length];
        }

        // --- TASK DETAIL ---
        function openTaskDetail(id) {
            activeTaskId = id;
            const task = tasks.find(t => t.id === id);
            if(!task) return;
            document.getElementById('view-task-detail').classList.remove('hidden');
            document.getElementById('td-title-input').value = task.title;
            document.getElementById('td-desc-input').value = task.description || "";
            document.getElementById('td-date-input').value = task.date;
            const groupSel = document.getElementById('td-group-select'); groupSel.innerHTML = ''; projects.forEach(p => { const opt = document.createElement('option'); opt.value = p; opt.innerText = p; if(p === task.group) opt.selected = true; groupSel.appendChild(opt); });
            const prioSel = document.getElementById('td-prio-select'); prioSel.value = task.priority || 'Medium'; updatePrioStyle(task.priority);
            ['todo', 'progress', 'done'].forEach(s => { const btn = document.getElementById(`btn-stat-${s}`); if(s === task.status) { btn.classList.remove('bg-transparent', 'text-gray-500'); btn.classList.add('bg-task-purple', 'text-white', 'shadow-md'); } else { btn.classList.add('bg-transparent', 'text-gray-500'); btn.classList.remove('bg-task-purple', 'text-white', 'shadow-md'); } });
            renderSubTasks(task); isEditing = true; toggleEditMode();
        }
        function toggleEditMode() {
            isEditing = !isEditing;
            const container = document.getElementById('task-detail-content');
            const inputs = document.querySelectorAll('.editable-input');
            const btn = document.getElementById('btn-edit-toggle');
            const grpIcon = document.getElementById('td-group-icon');
            const dateWrap = document.getElementById('td-date-wrapper');
            if(isEditing) { container.classList.add('is-editing'); inputs.forEach(el => { el.removeAttribute('readonly'); el.removeAttribute('disabled'); }); btn.innerHTML = '<i class="ph-bold ph-check text-xl"></i>'; btn.className = "w-10 h-10 rounded-full bg-green-50 flex items-center justify-center text-green-600"; grpIcon.style.opacity = '1'; dateWrap.classList.add('bg-white', 'border-gray-200'); dateWrap.classList.remove('bg-gray-50', 'border-transparent'); } else { container.classList.remove('is-editing'); inputs.forEach(el => { if(el.tagName === 'SELECT' || el.type === 'date') el.setAttribute('disabled', 'true'); else el.setAttribute('readonly', 'true'); }); btn.innerHTML = '<i class="ph-bold ph-pencil-simple text-xl"></i>'; btn.className = "w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-500"; grpIcon.style.opacity = '0'; dateWrap.classList.remove('bg-white', 'border-gray-200'); dateWrap.classList.add('bg-gray-50', 'border-transparent'); }
        }
        function updateTaskField(field, value) { if(!activeTaskId) return; const task = tasks.find(t => t.id === activeTaskId); task[field] = value; if(field === 'priority') updatePrioStyle(value); saveToLocal(); refreshAllViews(); }
        function updatePrioStyle(val) { const sel = document.getElementById('td-prio-select'); sel.className = `editable-input appearance-none badge-prio font-bold outline-none text-center border-none cursor-pointer ${val === 'High' ? 'prio-high' : (val === 'Low' ? 'prio-low' : 'prio-med')}`; }
        function closeTaskDetail() { document.getElementById('view-task-detail').classList.add('hidden'); activeTaskId = null; }
        function updateTaskStatus(newStatus) { if(!activeTaskId) return; const task = tasks.find(t => t.id === activeTaskId); task.status = newStatus; saveToLocal(); openTaskDetail(activeTaskId); refreshAllViews(); }
        function deleteOpenTask() { if(confirm("Delete this task?")) { tasks = tasks.filter(t => t.id !== activeTaskId); saveToLocal(); closeTaskDetail(); refreshAllViews(); } }
        function renderSubTasks(task) { const list = document.getElementById('subtask-list'); list.innerHTML = ''; if(!task.subtasks) task.subtasks = []; task.subtasks.forEach((st, idx) => { list.innerHTML += `<div class="flex items-center justify-between subtask-item"><div onclick="toggleSubTask(${idx})" class="flex items-center gap-3 cursor-pointer"><div class="checkbox ${st.done ? 'checked' : ''}"><i class="ph-bold ph-check text-xs ${st.done ? '' : 'hidden'}"></i></div><span class="subtask-text text-sm font-bold ${st.done ? 'checked' : ''}">${st.text}</span></div><button onclick="deleteSubTask(${idx})" class="subtask-delete hidden text-red-400"><i class="ph-bold ph-trash"></i></button></div>`; }); }
        function addSubTask() { const input = document.getElementById('new-subtask'); if(!input.value.trim()) return; const task = tasks.find(t => t.id === activeTaskId); if(!task.subtasks) task.subtasks = []; task.subtasks.push({ text: input.value, done: false }); saveToLocal(); input.value = ''; renderSubTasks(task); }
        function toggleSubTask(idx) { const task = tasks.find(t => t.id === activeTaskId); task.subtasks[idx].done = !task.subtasks[idx].done; saveToLocal(); renderSubTasks(task); refreshAllViews(); }
        function deleteSubTask(idx) { const task = tasks.find(t => t.id === activeTaskId); task.subtasks.splice(idx, 1); saveToLocal(); renderSubTasks(task); refreshAllViews(); }

        // --- PROJECT DETAIL (DRAG & DROP) ---
        function openGroupDetail(group) {
            currentViewingGroup = group;
            document.getElementById('view-project-detail').classList.remove('hidden');
            document.getElementById('detail-title').innerText = group;
            renderGroupTasks(group);
        }
        function renderGroupTasks(group) {
            const containers = {
                todo: document.getElementById('detail-list-todo'),
                progress: document.getElementById('detail-list-progress'),
                done: document.getElementById('detail-list-done')
            };
            
            // Reset HTML
            containers.todo.innerHTML = '<h3 class="text-xs font-bold text-gray-400 uppercase tracking-wide mb-2 mt-4">To Do</h3>';
            containers.progress.innerHTML = '<h3 class="text-xs font-bold text-gray-400 uppercase tracking-wide mb-2 mt-4">In Progress</h3>';
            containers.done.innerHTML = '<h3 class="text-xs font-bold text-gray-400 uppercase tracking-wide mb-2 mt-4">Completed</h3>';
            
            const groupTasks = tasks.filter(t => t.group === group);
            groupTasks.forEach(t => {
                if(containers[t.status]) containers[t.status].innerHTML += createTaskHTML(t);
            });

            // Initialize Sortable
            ['todo', 'progress', 'done'].forEach(status => {
                new Sortable(containers[status], {
                    group: 'shared', // Allow dragging between lists
                    animation: 150,
                    delay: 100, // Slight delay for touch to prevent scrolling interference
                    delayOnTouchOnly: true,
                    ghostClass: 'sortable-ghost',
                    dragClass: 'sortable-drag',
                    onEnd: function (evt) {
                        const itemEl = evt.item;
                        const newStatus = evt.to.getAttribute('data-status');
                        const taskId = parseInt(itemEl.getAttribute('data-id'));
                        
                        if (taskId && newStatus) {
                            const task = tasks.find(t => t.id === taskId);
                            if (task && task.status !== newStatus) {
                                task.status = newStatus;
                                saveToLocal();
                                refreshAllViews(); // Update counts elsewhere
                            }
                        }
                    }
                });
            });
        }
        function closeGroupDetail() { document.getElementById('view-project-detail').classList.add('hidden'); currentViewingGroup = null; }
        
        // --- ADD MODAL ---
        function openAddView(){ document.getElementById('view-add').classList.remove('hidden'); const select = document.getElementById('inp-group'); select.innerHTML = ''; projects.forEach(p => select.innerHTML += `<option value="${p}">${p}</option>`); tempSubtasks = []; renderTempSubtasks(); }
        function openAddViewFromProject() { openAddView(); if(currentViewingGroup) document.getElementById('inp-group').value = currentViewingGroup; }
        function closeAddView(){document.getElementById('view-add').classList.add('hidden');}
        function addTempSubtask() { const inp = document.getElementById('inp-temp-subtask'); if(inp.value.trim()) { tempSubtasks.push({text: inp.value.trim(), done: false}); renderTempSubtasks(); inp.value = ''; } }
        function renderTempSubtasks() { const list = document.getElementById('temp-subtask-list'); list.innerHTML = ''; tempSubtasks.forEach((st, i) => list.innerHTML += `<div class="flex items-center justify-between bg-gray-50 px-3 py-2 rounded-xl"><span class="text-sm font-bold text-gray-700">${st.text}</span><button onclick="tempSubtasks.splice(${i},1); renderTempSubtasks()" class="text-red-400"><i class="ph-bold ph-trash"></i></button></div>`); }
        function saveTask(){
            const t = document.getElementById('inp-title').value; if(!t) return alert("Title required");
            const g = document.getElementById('inp-group').value; if(!projects.includes(g)) { projects.push(g); localStorage.setItem('tm_projects', JSON.stringify(projects)); }
            tasks.push({ id:Date.now(), title:t, group: g, date:document.getElementById('inp-date').value, priority: document.getElementById('inp-priority').value, description: document.getElementById('inp-desc').value, status:'todo', subtasks: [...tempSubtasks] });
            saveToLocal(); closeAddView(); refreshAllViews(); document.getElementById('inp-title').value = ''; document.getElementById('inp-desc').value = '';
        }

        // --- SHARED UTILS ---
        function toggleStatus(id, e) { e.stopPropagation(); const task = tasks.find(t => t.id === id); task.status = task.status === 'done' ? 'todo' : (task.status === 'todo' ? 'progress' : 'done'); saveToLocal(); refreshAllViews(); }
        function deleteTask(id, e) { e.stopPropagation(); if(confirm('Delete?')) { tasks = tasks.filter(t => t.id !== id); saveToLocal(); refreshAllViews(); } }
        function setFilter(f) { currentFilter=f; renderTasks(); ['all','todo','progress','done'].forEach(k => document.getElementById(`tab-${k}`).className = k===f ? "px-5 py-2.5 rounded-2xl font-bold text-sm bg-task-purple text-white shadow-lg transition-all flex-shrink-0" : "px-5 py-2.5 rounded-2xl font-bold text-sm bg-white text-gray-400 transition-all flex-shrink-0"); }
        function refreshAllViews() { selectDate(selectedDate); updateStats(); if(currentViewingGroup) renderGroupTasks(currentViewingGroup); renderProjects(); }
        function changeMonth(dir) { displayMonth.setMonth(displayMonth.getMonth() + dir); renderCalendarGrid(); }
        
        function renderCalendarGrid() {
            const year = displayMonth.getFullYear(); const month = displayMonth.getMonth();
            document.getElementById('cal-month-name').innerText = `${monthNames[month]} ${year}`;
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const grid = document.getElementById('month-grid'); grid.innerHTML = '';
            for(let i=0; i<firstDay; i++) grid.innerHTML += `<div></div>`;
            for(let d=1; d<=daysInMonth; d++) {
                const dateStr = new Date(year, month, d+1).toISOString().split('T')[0];
                const hasTask = tasks.some(t => t.date === dateStr);
                const isToday = dateStr === new Date().toISOString().split('T')[0];
                grid.innerHTML += `<div class="cal-day ${isToday?'today':''} ${hasTask?'has-task':''}">${d}</div>`;
            }
            renderCalendarList();
        }
        function renderCalendarList() {
            const list = document.getElementById('calendar-tasks'); list.innerHTML = '';
            const m = displayMonth.getMonth(); const y = displayMonth.getFullYear();
            const mTasks = tasks.filter(t => { const d=new Date(t.date); return d.getMonth()===m && d.getFullYear()===y; });
            if(mTasks.length === 0) { list.innerHTML = '<p class="text-center text-gray-400 text-sm mt-4">No tasks this month</p>'; return; }
            mTasks.forEach(t => list.innerHTML += createTaskHTML(t));
        }
        function updateStats() {
            document.getElementById('stat-completed').innerText = tasks.filter(t=>t.status==='done').length;
            document.getElementById('stat-pending').innerText = tasks.filter(t=>t.status!=='done').length;
        }
        function saveToLocal() { localStorage.setItem('tm_tasks', JSON.stringify(tasks)); }

        init();
    </script>
</body>
</html>