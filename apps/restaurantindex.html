<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gourmet Tracker</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        slate: { 850: '#151f32', 900: '#0f172a' },
                        brand: { 500: '#da3743', 600: '#b91c1c' },
                        gold: { 400: '#fbbf24', 500: '#f59e0b' }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0f172a; color: #f8fafc; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
        .hero-pattern { background-image: radial-gradient(rgba(255, 255, 255, 0.1) 1px, transparent 1px); background-size: 20px 20px; }
        
        .rest-card { transition: transform 0.2s, box-shadow 0.2s; }
        .rest-card:hover { transform: translateY(-4px); box-shadow: 0 10px 30px -10px rgba(218, 55, 67, 0.3); }
        
        .mode-btn.active { background-color: white; color: #0f172a; font-weight: 600; }
        .mode-btn { background-color: rgba(255,255,255,0.1); color: #94a3b8; transition: all 0.2s; }
        .filter-btn-active { background-color: #da3743 !important; border-color: #da3743 !important; color: white !important; }

        /* Map Markers */
        .custom-pin { display: flex; align-items: center; justify-content: center; border-radius: 50%; border: 2px solid white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5); transition: transform 0.2s; }
        .custom-pin:hover { transform: scale(1.2); z-index: 999 !important; }
        .pin-visited { background-color: #f59e0b; color: white; } /* Gold Color */
        .pin-suggest { background-color: #da3743; color: white; } /* Red Color */
        
        /* Map Popup & Tooltip */
        .leaflet-popup-content-wrapper { background: #1e293b; color: white; border-radius: 12px; padding: 0; overflow: hidden; border: 1px solid #334155; }
        .leaflet-popup-tip { background: #1e293b; border: 1px solid #334155; }
        .leaflet-popup-content { margin: 0; width: 200px !important; }
        
        .custom-tooltip {
            background-color: rgba(15, 23, 42, 0.95);
            border: 1px solid #334155;
            color: white;
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 13px;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0,0,0,0.5);
        }
        .leaflet-tooltip-top:before { border-top-color: rgba(15, 23, 42, 0.95); }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <header class="h-16 border-b border-slate-800 bg-slate-900/95 backdrop-blur flex items-center justify-between px-4 md:px-8 z-50 shrink-0">
        <div class="flex items-center gap-2 cursor-pointer" onclick="goHome()">
            <div class="w-8 h-8 bg-brand-500 rounded-lg flex items-center justify-center text-white"><i class="ph ph-bowl-food text-xl"></i></div>
            <h1 class="font-bold text-lg tracking-tight hidden md:block">Gourmet<span class="text-brand-500">Tracker</span></h1>
        </div>
        
        <div class="flex-1 max-w-md mx-4 hidden md:block">
            <div class="relative group">
                <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-brand-500 transition-colors"></i>
                <input type="text" id="global-search" placeholder="Search..." 
                    class="w-full bg-slate-800 border border-slate-700 rounded-full py-2 pl-10 pr-4 text-sm focus:outline-none focus:border-brand-500 focus:ring-1 focus:ring-brand-500 transition-all text-white placeholder-slate-500">
            </div>
        </div>

        <div class="flex items-center gap-2">
            <button onclick="changeView('map')" class="p-2 text-slate-400 hover:text-white relative" title="Map View"><i class="ph ph-map-trifold text-xl"></i></button>
            <button onclick="changeView('saved')" class="p-2 text-slate-400 hover:text-white relative" title="Saved"><i class="ph ph-bookmark-simple text-xl"></i><span id="badge-saved" class="hidden absolute top-1 right-1 w-2 h-2 bg-brand-500 rounded-full"></span></button>
            <button onclick="changeView('bookings')" class="p-2 text-slate-400 hover:text-white relative" title="Reservations"><i class="ph ph-calendar-check text-xl"></i><span id="badge-bookings" class="hidden absolute top-1 right-1 w-2 h-2 bg-brand-500 rounded-full"></span></button>
            <button onclick="openAddModal()" class="bg-brand-500 hover:bg-brand-600 text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg shadow-brand-900/20 transition-transform active:scale-95 ml-2">Log Visit</button>
        </div>
    </header>

    <main class="flex-1 overflow-hidden relative" id="main-content">
        
        <div id="view-discover" class="h-full overflow-y-auto scroll-smooth pb-20">
            <div class="relative h-72 bg-slate-900 border-b border-slate-800 overflow-hidden flex flex-col items-center justify-center pt-4">
                <div class="absolute inset-0 hero-pattern opacity-20"></div>
                <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-slate-900/50 to-transparent"></div>
                
                <div class="z-10 text-center space-y-6 w-full max-w-2xl px-4">
                    <div class="flex justify-center">
                        <div class="flex bg-slate-800 p-1 rounded-full border border-slate-700 shadow-xl">
                            <button onclick="setMode('dining')" id="btn-mode-dining" class="mode-btn active px-6 py-2 rounded-full text-sm font-medium flex items-center gap-2"><i class="ph ph-knife-fork"></i> Dining</button>
                            <button onclick="setMode('coffee')" id="btn-mode-coffee" class="mode-btn px-6 py-2 rounded-full text-sm font-medium flex items-center gap-2"><i class="ph ph-coffee"></i> Coffee</button>
                            <button onclick="setMode('drinks')" id="btn-mode-drinks" class="mode-btn px-6 py-2 rounded-full text-sm font-medium flex items-center gap-2"><i class="ph ph-martini"></i> Drinks</button>
                        </div>
                    </div>
                    <h2 id="hero-title" class="text-4xl md:text-5xl font-bold text-white tracking-tight">Find your table for any occasion</h2>
                    <div id="hero-tags" class="flex flex-wrap justify-center gap-2"></div>
                </div>
            </div>

            <div class="max-w-7xl mx-auto px-4 md:px-8 mt-8">
                <div class="flex flex-col md:flex-row md:items-end justify-between mb-4 gap-4">
                    <div><h3 id="section-title-popular" class="text-xl font-bold text-white">Popular Restaurants</h3><span class="text-xs text-slate-400 uppercase tracking-wider">Based on reviews</span></div>
                    <div class="flex gap-2 overflow-x-auto pb-1 hide-scroll items-center">
                        <button onclick="toggleUserLocation()" id="btn-near-me" class="bg-slate-800 border border-slate-700 text-slate-300 text-xs rounded-lg px-3 py-2 flex items-center gap-2 hover:bg-slate-700 transition-colors whitespace-nowrap"><i class="ph ph-map-pin"></i> Near Me</button>
                        <div class="w-px h-6 bg-slate-700 mx-1"></div>
                        <select id="disc-filter-loc" onchange="renderDiscovery()" class="bg-slate-800 border border-slate-700 text-slate-300 text-xs rounded-lg px-3 py-2 outline-none focus:border-brand-500 cursor-pointer"><option value="all">Any Location</option></select>
                        <select id="disc-filter-cuisine" onchange="renderDiscovery()" class="bg-slate-800 border border-slate-700 text-slate-300 text-xs rounded-lg px-3 py-2 outline-none focus:border-brand-500 cursor-pointer"><option value="all">Any Cuisine</option></select>
                        <select id="disc-filter-price" onchange="renderDiscovery()" class="bg-slate-800 border border-slate-700 text-slate-300 text-xs rounded-lg px-3 py-2 outline-none focus:border-brand-500 cursor-pointer"><option value="all">Any Price</option><option value="1">£</option><option value="2">££</option><option value="3">£££</option><option value="4">££££</option></select>
                        <button onclick="resetFilters()" class="text-xs text-slate-500 hover:text-white px-2">Reset</button>
                    </div>
                </div>
                <div class="flex gap-4 overflow-x-auto hide-scroll pb-4 min-h-[250px]" id="feed-popular"></div>
            </div>

            <div class="max-w-7xl mx-auto px-4 md:px-8 mt-8">
                <div class="flex justify-between items-end mb-4">
                    <div><h3 class="text-xl font-bold text-white">History</h3><p id="section-subtitle-history" class="text-xs text-slate-400">Places you have logged.</p></div>
                    <button onclick="changeView('visited-list')" class="text-brand-500 text-sm hover:underline font-medium flex items-center gap-1">View All & Filter <i class="ph ph-caret-right"></i></button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="feed-history"></div>
            </div>
        </div>

        <div id="view-map" class="hidden w-full h-full relative z-0">
            <div id="map-container" class="w-full h-full bg-slate-900"></div>
            <div class="absolute bottom-6 left-6 z-[1000] bg-slate-900/90 backdrop-blur border border-slate-700 p-4 rounded-xl shadow-2xl">
                <h4 class="text-xs font-bold text-white mb-2 uppercase">Legend</h4>
                <div class="flex items-center gap-2 mb-1"><span class="w-3 h-3 rounded-full bg-yellow-500 border border-white"></span><span class="text-xs text-slate-300">Visited (Gold)</span></div>
                <div class="flex items-center gap-2 mb-1"><span class="w-3 h-3 rounded-full bg-red-600 border border-white"></span><span class="text-xs text-slate-300">Suggestion (Red)</span></div>
                <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-blue-500 animate-pulse border border-white"></span><span class="text-xs text-slate-300">You</span></div>
                <button onclick="toggleUserLocation()" class="mt-3 w-full bg-slate-700 hover:bg-slate-600 text-xs py-1 rounded text-white transition-colors">Find Me</button>
            </div>
        </div>

        <div id="view-visited-list" class="hidden h-full overflow-y-auto max-w-7xl mx-auto px-4 py-8">
            <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
                <div><button onclick="goHome()" class="text-slate-400 text-sm hover:text-white mb-2 flex items-center gap-1"><i class="ph ph-arrow-left"></i> Back</button><h2 class="text-3xl font-bold text-white">Visited Places</h2></div>
                <div class="flex flex-wrap gap-2">
                    <input type="text" id="visit-search" onkeyup="renderVisitedList()" placeholder="Search visited..." class="bg-slate-800 border border-slate-700 text-white text-xs rounded-lg pl-3 pr-3 py-2 outline-none focus:border-brand-500 w-32">
                    <select id="visit-filter-loc" onchange="renderVisitedList()" class="bg-slate-800 border border-slate-700 text-slate-300 text-xs rounded-lg px-3 py-2 outline-none focus:border-brand-500 cursor-pointer"><option value="all">All Locations</option></select>
                    <select id="visit-filter-rating" onchange="renderVisitedList()" class="bg-slate-800 border border-slate-700 text-slate-300 text-xs rounded-lg px-3 py-2 outline-none focus:border-brand-500 cursor-pointer"><option value="all">Any Rating</option><option value="5">5 Stars</option><option value="4">4+ Stars</option></select>
                    <button onclick="clearVisitFilters()" class="text-xs text-slate-500 hover:text-white underline">Clear</button>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="visited-grid"></div>
        </div>

        <div id="view-saved" class="hidden h-full overflow-y-auto max-w-5xl mx-auto px-4 py-8">
            <button onclick="goHome()" class="text-slate-400 text-sm hover:text-white mb-4 flex items-center gap-1"><i class="ph ph-arrow-left"></i> Back</button>
            <h2 class="text-2xl font-bold mb-6 flex items-center gap-2"><i class="ph ph-bookmark-simple text-brand-500"></i> Saved Places</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="list-saved"></div>
        </div>
        <div id="view-bookings" class="hidden h-full overflow-y-auto max-w-4xl mx-auto px-4 py-8">
            <button onclick="goHome()" class="text-slate-400 text-sm hover:text-white mb-4 flex items-center gap-1"><i class="ph ph-arrow-left"></i> Back</button>
            <h2 class="text-2xl font-bold mb-6 flex items-center gap-2"><i class="ph ph-calendar-check text-brand-500"></i> Upcoming Reservations</h2>
            <div class="space-y-4" id="list-bookings"></div>
        </div>

    </main>

    <div id="modal-detail" class="fixed inset-0 bg-slate-900/90 backdrop-blur-sm hidden z-[60] flex justify-end">
        <div class="w-full max-w-2xl bg-slate-900 h-full shadow-2xl border-l border-slate-700 overflow-y-auto animate-slide-left">
            <div class="h-64 bg-slate-800 relative">
                <img id="detail-image" src="" class="w-full h-full object-cover opacity-60">
                <div class="absolute inset-0 bg-gradient-to-t from-slate-900 to-transparent"></div>
                <button onclick="closeModal('modal-detail')" class="absolute top-4 left-4 bg-black/50 p-2 rounded-full text-white hover:bg-black/70 transition-colors"><i class="ph ph-arrow-left text-xl"></i></button>
                <div class="absolute bottom-6 left-6 right-6">
                    <div class="flex gap-2 mb-2" id="detail-tags"></div>
                    <h1 id="detail-name" class="text-4xl font-bold text-white mb-2 shadow-sm">Restaurant Name</h1>
                    <div class="flex flex-wrap items-center gap-4 text-sm text-slate-200">
                        <span id="detail-cuisine">Italian</span><span>•</span><span id="detail-price">£££</span><span>•</span><span id="detail-location">Soho</span>
                    </div>
                    <p id="detail-address" class="text-xs text-slate-400 mt-1 opacity-80"></p>
                </div>
            </div>
            <div class="p-6 space-y-8">
                <div class="flex gap-3">
                    <button onclick="makeReservation()" class="flex-1 bg-brand-600 hover:bg-brand-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-brand-900/20 transition-all active:scale-95">Make a Reservation</button>
                    <button onclick="toggleSaveDetail()" id="btn-save-detail" class="px-4 py-3 bg-slate-800 border border-slate-700 hover:bg-slate-700 text-white rounded-xl transition-colors"><i class="ph ph-bookmark-simple text-xl"></i></button>
                    <button onclick="openReviewMode()" class="px-4 py-3 bg-slate-800 border border-slate-700 hover:bg-slate-700 text-white rounded-xl transition-colors"><i class="ph ph-pencil-simple text-xl"></i></button>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-slate-800/50 p-4 rounded-xl border border-slate-700"><span class="text-slate-400 text-xs uppercase font-bold">Overall Rating</span><div class="flex items-end gap-2"><span id="detail-rating" class="text-3xl font-bold text-white">4.5</span><div id="detail-stars" class="text-brand-500 text-sm mb-1 flex"></div></div></div>
                    <div class="bg-slate-800/50 p-4 rounded-xl border border-slate-700"><span class="text-slate-400 text-xs uppercase font-bold">My Visits</span><div class="flex items-end gap-2"><span id="detail-visits" class="text-3xl font-bold text-white">0</span><span class="text-xs text-slate-500 mb-1">times</span></div></div>
                </div>
                <div><h3 class="font-bold text-lg text-white mb-4">Your Notes & Reviews</h3><div id="detail-reviews" class="space-y-4"></div></div>
            </div>
        </div>
    </div>

    <div id="modal-add" class="fixed inset-0 bg-slate-900/90 backdrop-blur-sm hidden z-[70] flex items-center justify-center p-4">
        <div class="bg-slate-800 w-full max-w-lg rounded-2xl border border-slate-700 shadow-2xl flex flex-col max-h-[90vh]">
            <div class="p-5 border-b border-slate-700 flex justify-between items-center"><h3 class="font-bold text-lg text-white">Log Experience</h3><button onclick="closeModal('modal-add')" class="text-slate-400 hover:text-white"><i class="ph ph-x text-xl"></i></button></div>
            <div class="p-6 overflow-y-auto space-y-4">
                
                <div class="relative">
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Place Name (Auto-Search)</label>
                    <input type="text" id="log-name" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 text-white focus:border-brand-500 outline-none" placeholder="Type to search OSM..." oninput="debounceSearch(this.value)">
                    <div id="search-results" class="hidden absolute top-full left-0 w-full bg-slate-800 border border-slate-700 rounded-lg mt-1 max-h-48 overflow-y-auto z-50 shadow-xl"></div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Address / Location</label>
                    <input type="text" id="log-location" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 text-white focus:border-brand-500 outline-none" placeholder="e.g. 7 Boundary St, London">
                    <p class="text-[10px] text-slate-500 mt-1">Required for map pin. Auto-filled if you select from search.</p>
                </div>

                <div class="grid grid-cols-2 gap-4"><div><label class="block text-xs font-bold text-slate-400 uppercase mb-1">Date</label><input type="date" id="log-date" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 text-white focus:border-brand-500 outline-none"></div><div><label class="block text-xs font-bold text-slate-400 uppercase mb-1">Total Spend (£)</label><input type="number" id="log-spend" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 text-white focus:border-brand-500 outline-none" placeholder="0.00"></div></div>
                <div><label class="block text-xs font-bold text-slate-400 uppercase mb-2">My Rating</label><div class="flex justify-between bg-slate-900 p-3 rounded-lg border border-slate-700"><div class="text-center"><div class="text-xs text-slate-500 mb-1">Product</div><input type="number" id="rate-food" min="1" max="5" value="4" class="w-10 bg-slate-800 text-center rounded border border-slate-600"></div><div class="text-center"><div class="text-xs text-slate-500 mb-1">Service</div><input type="number" id="rate-service" min="1" max="5" value="4" class="w-10 bg-slate-800 text-center rounded border border-slate-600"></div><div class="text-center"><div class="text-xs text-slate-500 mb-1">Vibe</div><input type="number" id="rate-atmosphere" min="1" max="5" value="4" class="w-10 bg-slate-800 text-center rounded border border-slate-600"></div></div></div>
                <div><label class="block text-xs font-bold text-slate-400 uppercase mb-1">Review / Notes</label><textarea id="log-notes" rows="3" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 text-white focus:border-brand-500 outline-none" placeholder="What was good? What wasn't?"></textarea></div>
            </div>
            <div class="p-5 border-t border-slate-700 flex justify-end"><button onclick="saveLog()" class="bg-brand-500 hover:bg-brand-600 text-white px-6 py-2 rounded-lg font-bold shadow-lg">Save Log</button></div>
        </div>
    </div>

    <script>
        // MOCK DATA (With real lat/lng for demo)
        const MOCK_DB = [
            // DINING
            { id: 'm1', type: 'dining', name: "Dishoom", cuisine: "Indian", price: 2, location: "Shoreditch", lat: 51.5229, lng: -0.0777, rating: 4.8, reviews: 2400, image: "https://images.unsplash.com/photo-1585937421612-70a008356f36?auto=format&fit=crop&q=80&w=400", address: "7 Boundary St, London E2 7JE" },
            { id: 'm2', type: 'dining', name: "Gloria", cuisine: "Italian", price: 3, location: "Shoreditch", lat: 51.5255, lng: -0.0792, rating: 4.6, reviews: 1800, image: "https://images.unsplash.com/photo-1551183053-bf91a1d81141?auto=format&fit=crop&q=80&w=400", address: "54-56 Great Eastern St, London EC2A 3QR" },
            { id: 'm3', type: 'dining', name: "Sushi Samba", cuisine: "Japanese", price: 4, location: "City", lat: 51.5162, lng: -0.0798, rating: 4.5, reviews: 3100, image: "https://images.unsplash.com/photo-1579871494447-9811cf80d66c?auto=format&fit=crop&q=80&w=400", address: "Heron Tower, London EC2N 4AY" },
            { id: 'm4', type: 'dining', name: "Flat Iron", cuisine: "Steakhouse", price: 2, location: "Soho", lat: 51.5138, lng: -0.1339, rating: 4.7, reviews: 5000, image: "https://images.unsplash.com/photo-1600891964092-4316c288032e?auto=format&fit=crop&q=80&w=400", address: "17 Beak St, London W1F 9RW" },
            
            // COFFEE
            { id: 'c1', type: 'coffee', name: "Monmouth Coffee", cuisine: "Coffee Shop", price: 1, location: "Borough", lat: 51.5055, lng: -0.0909, rating: 4.9, reviews: 1200, image: "https://images.unsplash.com/photo-1497935586351-b67a49e012bf?auto=format&fit=crop&q=80&w=400", address: "2 Park St, London SE1 9AB" },
            { id: 'c2', type: 'coffee', name: "WatchHouse", cuisine: "Specialty Coffee", price: 2, location: "Bermondsey", lat: 51.5019, lng: -0.0754, rating: 4.7, reviews: 800, image: "https://images.unsplash.com/photo-1554118811-1e0d58224f24?auto=format&fit=crop&q=80&w=400", address: "199 Bermondsey St, London SE1 3UW" },

            // DRINKS
            { id: 'd1', type: 'drinks', name: "Nightjar", cuisine: "Speakeasy", price: 3, location: "Shoreditch", lat: 51.5262, lng: -0.0881, rating: 4.8, reviews: 3000, image: "https://images.unsplash.com/photo-1514362545857-3bc16549766b?auto=format&fit=crop&q=80&w=400", address: "129 City Rd, London EC1V 1JB" },
            { id: 'd2', type: 'drinks', name: "The Connaught Bar", cuisine: "Cocktails", price: 4, location: "Mayfair", lat: 51.5097, lng: -0.1491, rating: 4.9, reviews: 1100, image: "https://images.unsplash.com/photo-1572116469696-31de0f17cc34?auto=format&fit=crop&q=80&w=400", address: "Carlos Pl, London W1K 2AL" }
        ];

        let appData = {
            restaurants: JSON.parse(localStorage.getItem('journal_restaurants')) || [],
            visits: JSON.parse(localStorage.getItem('journal_visits')) || [],
            bookings: JSON.parse(localStorage.getItem('journal_bookings')) || []
        };

        let currentDetailId = null;
        let currentMode = 'dining';
        let userLocation = null;
        let isNearMeActive = false;
        let mapInstance = null;
        let mapMarkers = [];
        let searchTimeout = null;
        let tempSelectedPlace = null; 

        // --- SELF-HEALING DATA ---
        async function fixLegacyData() {
            let changed = false;
            for (let r of appData.restaurants) {
                if (!r.lat || !r.lng) {
                    console.log("Fixing missing coords for:", r.name);
                    const mock = MOCK_DB.find(m => m.name === r.name);
                    if (mock) {
                        r.lat = mock.lat; r.lng = mock.lng; r.address = mock.address;
                        changed = true;
                    } else if (r.location && r.location !== 'Unknown') {
                        // Try fetching
                        const fetched = await fetchCoordsForName(r.name + " " + r.location);
                        if (fetched) {
                            r.lat = fetched.lat; r.lng = fetched.lng; r.address = fetched.address;
                            changed = true;
                        }
                    }
                }
            }
            if (changed) saveData();
        }

        function init() {
            setMode('dining'); 
            updateDatalist();
            document.getElementById('log-date').valueAsDate = new Date();
            // Run background fix
            setTimeout(fixLegacyData, 1000);
        }

        function saveData() {
            localStorage.setItem('journal_restaurants', JSON.stringify(appData.restaurants));
            localStorage.setItem('journal_visits', JSON.stringify(appData.visits));
            localStorage.setItem('journal_bookings', JSON.stringify(appData.bookings));
            if(!document.getElementById('view-discover').classList.contains('hidden')) renderDiscovery();
            
            // Re-render map if visible
            if(!document.getElementById('view-map').classList.contains('hidden')) {
                if(mapInstance) mapInstance.invalidateSize();
                renderMap();
            }
            if(!document.getElementById('view-visited-list').classList.contains('hidden')) {
                renderVisitedList();
            }
            renderHistoryPreview();
        }

        // --- SEARCH API ---
        function debounceSearch(query) {
            clearTimeout(searchTimeout);
            if(query.length < 3) { document.getElementById('search-results').classList.add('hidden'); return; }
            searchTimeout = setTimeout(() => performAddressSearch(query), 500);
        }

        async function performAddressSearch(query) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&addressdetails=1`);
                const results = await response.json();
                const resultsEl = document.getElementById('search-results');
                if(results.length > 0) {
                    resultsEl.innerHTML = results.map((item, index) => `
                        <div onclick="selectPlace(${index})" class="p-3 hover:bg-slate-700 cursor-pointer border-b border-slate-700/50">
                            <div class="font-bold text-sm text-white">${item.name || item.display_name.split(',')[0]}</div>
                            <div class="text-xs text-slate-400 truncate">${item.display_name}</div>
                        </div>`).join('');
                    resultsEl.classList.remove('hidden');
                    window.tempSearchResults = results;
                } else { resultsEl.classList.add('hidden'); }
            } catch(e) { console.error("Search failed", e); }
        }

        function selectPlace(index) {
            const item = window.tempSearchResults[index];
            const name = item.name || item.display_name.split(',')[0];
            document.getElementById('log-name').value = name;
            document.getElementById('log-location').value = item.display_name; 
            document.getElementById('search-results').classList.add('hidden');
            tempSelectedPlace = { name, address: item.display_name, lat: parseFloat(item.lat), lng: parseFloat(item.lon), location: item.address.suburb || item.address.city || 'Unknown' };
        }

        async function fetchCoordsForName(name) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(name)}&limit=1`);
                const results = await response.json();
                if (results.length > 0) return { lat: parseFloat(results[0].lat), lng: parseFloat(results[0].lon), address: results[0].display_name };
            } catch(e) {}
            return null;
        }

        async function fetchCoordsForAddress(address) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`);
                const results = await response.json();
                if (results.length > 0) return { lat: parseFloat(results[0].lat), lng: parseFloat(results[0].lon), address: results[0].display_name };
            } catch(e) {}
            return null;
        }

        // --- MAP LOGIC ---
        function initMap() {
            if (mapInstance) return;
            mapInstance = L.map('map-container', { zoomControl: false }).setView([51.505, -0.09], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OSM & CARTO', subdomains: 'abcd', maxZoom: 20 }).addTo(mapInstance);
            setTimeout(() => { mapInstance.invalidateSize(); renderMap(); }, 200);
        }

        function renderMap() {
            if (!mapInstance) return;
            mapMarkers.forEach(m => mapInstance.removeLayer(m));
            mapMarkers = [];

            if (userLocation) {
                const userIcon = L.divIcon({ className: '', html: `<div class="w-4 h-4 bg-blue-500 rounded-full border-2 border-white shadow-lg animate-pulse"></div>`, iconSize: [16, 16], iconAnchor: [8, 8] });
                const m = L.marker([userLocation.lat, userLocation.lng], { icon: userIcon }).addTo(mapInstance);
                m.bindTooltip("You", { direction: 'top', className: 'custom-tooltip', offset: [0, -10] });
                mapMarkers.push(m);
            }

            // 1. Visited (GOLD)
            const visitedIds = [...new Set(appData.visits.map(v => v.restId))];
            
            visitedIds.forEach(id => {
                const r = appData.restaurants.find(x => x.id === id) || MOCK_DB.find(x => x.id === id);
                
                // Allow showing visited regardless of mode in map view? Or strict mode? Strict is better for clutter.
                if (r && r.lat && r.lng && (r.type || 'dining') === currentMode) {
                    const icon = L.divIcon({ className: '', html: `<div class="custom-pin pin-visited w-8 h-8"><i class="ph ph-star-fill text-sm"></i></div>`, iconSize: [32, 32], iconAnchor: [16, 16] });
                    const m = L.marker([r.lat, r.lng], { icon: icon }).addTo(mapInstance);
                    m.bindTooltip(r.name, { permanent: false, direction: 'top', className: 'custom-tooltip', offset: [0, -20] });
                    m.bindPopup(`<b>${r.name}</b><br><span class="text-yellow-400">Visited</span><br><button onclick="openDetail('${r.id}')" class="mt-2 text-xs bg-slate-700 px-2 py-1 rounded text-white">Details</button>`);
                    mapMarkers.push(m);
                }
            });

            // 2. Suggestions (RED)
            MOCK_DB.forEach(r => {
                if (r.type === currentMode && !visitedIds.includes(r.id)) {
                    const icon = L.divIcon({ className: '', html: `<div class="custom-pin pin-suggest w-8 h-8"><i class="ph ph-fork-knife text-sm"></i></div>`, iconSize: [32, 32], iconAnchor: [16, 16] });
                    const m = L.marker([r.lat, r.lng], { icon: icon }).addTo(mapInstance);
                    m.bindTooltip(r.name, { permanent: false, direction: 'top', className: 'custom-tooltip', offset: [0, -20] });
                    m.bindPopup(`<b>${r.name}</b><br><span class="text-slate-400">Suggestion</span><br><button onclick="openDetail('${r.id}', true)" class="mt-2 text-xs bg-slate-700 px-2 py-1 rounded text-white">Details</button>`);
                    mapMarkers.push(m);
                }
            });
        }

        // --- UPDATED SAVE LOGIC ---
        async function saveLog() {
            const name = document.getElementById('log-name').value;
            const address = document.getElementById('log-location').value;
            const date = document.getElementById('log-date').value;
            const spend = document.getElementById('log-spend').value;
            const notes = document.getElementById('log-notes').value;
            if(!name) return alert("Please enter a name");

            let rId = currentDetailId;
            let r = appData.restaurants.find(x => x.name === name) || MOCK_DB.find(x => x.name === name);
            
            // If new place and no coords yet, try to fetch using the address field
            if (!r && !tempSelectedPlace && address) {
                const fetched = await fetchCoordsForAddress(address);
                if(fetched) {
                    tempSelectedPlace = { name: name, address: fetched.address, lat: fetched.lat, lng: fetched.lng, location: 'Unknown' };
                }
            }

            if (!r) {
                rId = 'r' + Date.now();
                const newPlace = {
                    id: rId,
                    name: name,
                    type: currentMode,
                    status: 'visited',
                    price: 2, 
                    cuisine: 'Mixed',
                    location: tempSelectedPlace ? tempSelectedPlace.location : 'Unknown',
                    address: tempSelectedPlace ? tempSelectedPlace.address : address,
                    lat: tempSelectedPlace ? tempSelectedPlace.lat : null,
                    lng: tempSelectedPlace ? tempSelectedPlace.lng : null,
                    image: "https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?auto=format&fit=crop&q=80&w=1000"
                };
                appData.restaurants.push(newPlace);
            } else {
                rId = r.id;
                const exist = appData.restaurants.find(x => x.id === rId);
                
                // Update missing coords on existing record
                if(exist && !exist.lat && tempSelectedPlace) {
                    exist.lat = tempSelectedPlace.lat;
                    exist.lng = tempSelectedPlace.lng;
                    exist.address = tempSelectedPlace.address;
                }
                
                if(exist) exist.status = 'visited';
                else appData.restaurants.push({...r, status: 'visited'});
            }

            const ratings = {
                food: parseInt(document.getElementById('rate-food').value),
                service: parseInt(document.getElementById('rate-service').value),
                atmosphere: parseInt(document.getElementById('rate-atmosphere').value),
                value: 0
            };

            appData.visits.push({ id: 'v' + Date.now(), restId: rId, date, spend, notes, ratings });
            tempSelectedPlace = null;
            saveData();
            closeModal('modal-add');
        }

        // --- UTILS ---
        function toggleUserLocation() {
            if (isNearMeActive) { isNearMeActive = false; document.getElementById('btn-near-me').classList.remove('filter-btn-active'); renderDiscovery(); } 
            else { 
                if (!navigator.geolocation) return alert("Geolocation unsupported");
                document.getElementById('btn-near-me').innerText = "Locating...";
                navigator.geolocation.getCurrentPosition((pos) => {
                    userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    isNearMeActive = true;
                    document.getElementById('btn-near-me').innerHTML = `<i class="ph ph-map-pin-fill"></i> Near Me`;
                    document.getElementById('btn-near-me').classList.add('filter-btn-active');
                    renderDiscovery();
                    if(mapInstance) { renderMap(); mapInstance.flyTo([userLocation.lat, userLocation.lng], 14); }
                }, () => { alert("Location access denied."); document.getElementById('btn-near-me').innerHTML = `<i class="ph ph-map-pin"></i> Near Me`; });
            }
        }
        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) { const R = 6371; const dLat = (lat2-lat1)*(Math.PI/180); const dLon = (lon2-lon1)*(Math.PI/180); const a = Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*(Math.PI/180))*Math.cos(lat2*(Math.PI/180))*Math.sin(dLon/2)*Math.sin(dLon/2); return R * (2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a))); }
        function setMode(mode) { currentMode = mode; document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active')); document.getElementById(`btn-mode-${mode}`).classList.add('active'); resetFilters(); populateDiscoveryFilters(); renderDiscovery(); renderHistoryPreview(); renderSaved(); renderBookings(); if(!document.getElementById('view-map').classList.contains('hidden')) renderMap(); }
        function populateDiscoveryFilters() { const loc = document.getElementById('disc-filter-loc'); const cui = document.getElementById('disc-filter-cuisine'); const fDB = MOCK_DB.filter(r => r.type === currentMode); loc.innerHTML = '<option value="all">Any Location</option>' + [...new Set(fDB.map(r => r.location))].sort().map(l => `<option>${l}</option>`).join(''); cui.innerHTML = '<option value="all">Any Cuisine</option>' + [...new Set(fDB.map(r => r.cuisine))].sort().map(c => `<option>${c}</option>`).join(''); }
        function quickFilter(c) { document.getElementById('disc-filter-cuisine').value = Array.from(document.getElementById('disc-filter-cuisine').options).find(o=>o.value.includes(c))?.value || 'all'; renderDiscovery(); }
        function resetFilters() { document.getElementById('disc-filter-loc').value = 'all'; document.getElementById('disc-filter-cuisine').value = 'all'; document.getElementById('disc-filter-price').value = 'all'; if(isNearMeActive) toggleUserLocation(); renderDiscovery(); }
        function renderDiscovery() {
            const feed = document.getElementById('feed-popular');
            const [loc, cui, pri] = ['loc','cuisine','price'].map(id => document.getElementById(`disc-filter-${id}`).value);
            let items = MOCK_DB.filter(r => r.type === currentMode && (loc === 'all' || r.location === loc) && (cui === 'all' || r.cuisine === cui) && (pri === 'all' || r.price == pri));
            if (isNearMeActive && userLocation) items = items.map(r => ({ ...r, distance: getDistanceFromLatLonInKm(userLocation.lat, userLocation.lng, r.lat, r.lng) })).sort((a,b) => a.distance - b.distance);
            if (items.length === 0) { feed.innerHTML = '<div class="text-slate-500 w-full text-center py-8">No places found.</div>'; return; }
            feed.innerHTML = items.map(r => `<div onclick="openDetail('${r.id}', true)" class="rest-card min-w-[280px] bg-slate-800 rounded-xl overflow-hidden border border-slate-700 cursor-pointer group relative"><div class="h-32 bg-slate-700 relative"><img src="${r.image}" class="w-full h-full object-cover group-hover:scale-105 transition-transform"><div class="absolute top-2 right-2 bg-white text-slate-900 text-xs font-bold px-2 py-1 rounded shadow">${r.rating} ★</div>${(r.distance ? `<div class="absolute top-2 left-2 bg-brand-600 text-white text-xs font-bold px-2 py-1 rounded shadow flex items-center gap-1"><i class="ph ph-map-pin"></i> ${r.distance.toFixed(1)} km</div>` : '')}</div><div class="p-4"><h3 class="font-bold text-white text-lg truncate">${r.name}</h3><p class="text-xs text-slate-400 mb-3">${r.cuisine} • ${r.location} • ${'£'.repeat(r.price)}</p></div></div>`).join('');
        }
        function populateVisitedFilters() { const vIds = [...new Set(appData.visits.map(v => v.restId))]; const vRest = vIds.map(id => appData.restaurants.find(x => x.id === id) || MOCK_DB.find(x => x.id === id)).filter(r => r && (r.type || 'dining') === currentMode); document.getElementById('visit-filter-loc').innerHTML = '<option value="all">All Locations</option>' + [...new Set(vRest.map(r => r.location))].sort().map(l => `<option>${l}</option>`).join(''); document.getElementById('visit-filter-cuisine').innerHTML = '<option value="all">All Cuisines</option>' + [...new Set(vRest.map(r => Array.isArray(r.cuisine) ? r.cuisine[0] : r.cuisine))].sort().map(c => `<option>${c}</option>`).join(''); }
        function renderVisitedList() {
            const grid = document.getElementById('visited-grid'); const [term, loc, cui, rate] = ['visit-search','visit-filter-loc','visit-filter-cuisine','visit-filter-rating'].map(id => document.getElementById(id).value.toLowerCase());
            const vIds = [...new Set(appData.visits.map(v => v.restId))];
            const filtered = vIds.map(id => appData.restaurants.find(x => x.id === id) || MOCK_DB.find(x => x.id === id)).filter(r => {
                if(!r || (r.type || 'dining') !== currentMode) return false;
                const visits = appData.visits.filter(v => v.restId === r.id);
                const avg = visits.reduce((a,v) => a + v.ratings.food, 0) / visits.length;
                
                // Case-Insensitive Filter Matching
                const matchesSearch = r.name.toLowerCase().includes(term);
                const matchesLoc = loc === 'all' || r.location.toLowerCase() === loc; // FIXED CASE
                const rCuisine = Array.isArray(r.cuisine) ? r.cuisine[0] : r.cuisine;
                const matchesCui = cui === 'all' || rCuisine.toLowerCase() === cui; // FIXED CASE
                const matchesRating = rate === 'all' || avg >= parseInt(rate);

                return matchesSearch && matchesLoc && matchesCui && matchesRating;
            });
            if (filtered.length === 0) { grid.innerHTML = '<div class="col-span-full text-center text-slate-500 py-12">No visited places found.</div>'; return; }
            grid.innerHTML = filtered.map(r => { const visits = appData.visits.filter(v => v.restId === r.id); const avg = (visits.reduce((a,v) => a + v.ratings.food, 0) / visits.length).toFixed(1); return `<div onclick="openDetail('${r.id}')" class="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden cursor-pointer hover:border-brand-500 transition-all group"><div class="h-40 bg-slate-700 relative"><img src="${r.image || 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?auto=format&fit=crop&q=80&w=400'}" class="w-full h-full object-cover"><div class="absolute bottom-2 left-2 bg-black/60 backdrop-blur text-white text-xs px-2 py-1 rounded flex items-center gap-1"><i class="ph ph-star-fill text-brand-500"></i> You: ${avg}</div></div><div class="p-4"><h3 class="font-bold text-white text-lg mb-1 group-hover:text-brand-500">${r.name}</h3><p class="text-xs text-slate-400 mb-3">${r.location}</p><div class="text-xs text-slate-500 border-t border-slate-700 pt-3 flex justify-between"><span>Visits: ${visits.length}</span></div></div></div>`; }).join('');
        }
        function renderHistoryPreview() {
            const list = document.getElementById('feed-history');
            const vIds = [...new Set(appData.visits.map(v => v.restId))].filter(id => { const r = appData.restaurants.find(x => x.id === id) || MOCK_DB.find(x => x.id === id); return r && (r.type || 'dining') === currentMode; }).slice(0, 3);
            if (vIds.length === 0) { list.innerHTML = '<div class="text-slate-500 text-sm italic col-span-full">No visits yet.</div>'; return; }
            list.innerHTML = vIds.map(id => { const r = appData.restaurants.find(x => x.id === id) || MOCK_DB.find(x => x.id === id); const visits = appData.visits.filter(v => v.restId === id); const avg = (visits.reduce((a,v) => a + v.ratings.food, 0) / visits.length).toFixed(1); return `<div onclick="openDetail('${id}')" class="flex gap-4 p-4 bg-slate-800/50 hover:bg-slate-800 rounded-xl border border-slate-700 transition-colors cursor-pointer"><div class="w-20 h-20 rounded-lg bg-slate-700 overflow-hidden shrink-0"><img src="${r.image || 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?auto=format&fit=crop&q=80&w=200'}" class="w-full h-full object-cover"></div><div class="flex-1 min-w-0 flex flex-col justify-center"><h4 class="font-bold text-white truncate">${r.name}</h4><p class="text-xs text-slate-400 mb-2">${r.cuisine}</p><div class="flex items-center gap-1 text-xs font-bold text-brand-500"><i class="ph ph-star-fill"></i> ${avg}</div></div></div>`; }).join('');
        }
        function renderSaved() { const list = document.getElementById('list-saved'); const saved = appData.restaurants.filter(r => r.status === 'want_to_try' && (r.type || 'dining') === currentMode); document.getElementById('badge-saved').className = saved.length > 0 ? "absolute top-1 right-1 w-2 h-2 bg-brand-500 rounded-full" : "hidden"; if(saved.length === 0) { list.innerHTML = '<div class="col-span-full text-slate-500">No saved places.</div>'; return; } list.innerHTML = saved.map(r => `<div onclick="openDetail('${r.id}')" class="bg-slate-800 border border-slate-700 rounded-xl p-4 flex justify-between items-center cursor-pointer hover:border-brand-500 transition-colors"><div><h4 class="font-bold text-white">${r.name}</h4><p class="text-xs text-slate-400">${r.cuisine} • ${r.location}</p></div><button class="bg-brand-600 text-white px-3 py-1 rounded text-xs">Book</button></div>`).join(''); }
        function renderBookings() { const list = document.getElementById('list-bookings'); const fut = appData.bookings.filter(b => { const r = appData.restaurants.find(x => x.name === b.name) || MOCK_DB.find(x => x.name === b.name); return (new Date(b.date) >= new Date().setHours(0,0,0,0)) && r && (r.type || 'dining') === currentMode; }); document.getElementById('badge-bookings').className = fut.length > 0 ? "absolute top-1 right-1 w-2 h-2 bg-brand-500 rounded-full" : "hidden"; list.innerHTML = fut.length === 0 ? '<div class="text-slate-500">No upcoming bookings.</div>' : fut.map(b => `<div class="bg-slate-800 border-l-4 border-brand-500 rounded-r-xl p-4 flex justify-between items-center"><div><h4 class="font-bold text-white">${b.name}</h4><p class="text-sm text-slate-300"><i class="ph ph-calendar text-brand-500"></i> ${new Date(b.date).toLocaleDateString()} @ ${b.time}</p><p class="text-xs text-slate-500 mt-1">${b.people} people</p></div><button onclick="cancelBooking('${b.id}')" class="text-slate-500 hover:text-red-400"><i class="ph ph-trash text-lg"></i></button></div>`).join(''); }
        function openDetail(id, isMock = false) { currentDetailId = id; let r = (isMock ? MOCK_DB : appData.restaurants).find(x => x.id === id) || appData.restaurants.find(x => x.id === id) || MOCK_DB.find(x => x.id === id); if (!r) return; document.getElementById('detail-image').src = r.image || "https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?auto=format&fit=crop&q=80&w=1000"; document.getElementById('detail-name').innerText = r.name; document.getElementById('detail-cuisine').innerText = Array.isArray(r.cuisine) ? r.cuisine[0] : r.cuisine; document.getElementById('detail-location').innerText = r.location; document.getElementById('detail-price').innerText = '£'.repeat(r.price || 2); document.getElementById('detail-rating').innerText = r.rating || '-'; document.getElementById('detail-address').innerText = r.address || ''; const iconMap = { dining: 'ph-knife-fork', coffee: 'ph-coffee', drinks: 'ph-martini' }; document.getElementById('detail-tags').innerHTML = `<span class="bg-brand-600/80 text-white text-[10px] px-2 py-0.5 rounded uppercase tracking-wider flex items-center gap-1"><i class="ph ${iconMap[r.type||'dining']}"></i> ${(r.type || 'Dining').toUpperCase()}</span>`; const isSaved = appData.restaurants.some(x => x.id === r.id && x.status === 'want_to_try'); document.getElementById('btn-save-detail').innerHTML = isSaved ? '<i class="ph ph-bookmark-simple-fill text-brand-500 text-xl"></i>' : '<i class="ph ph-bookmark-simple text-xl"></i>'; const visits = appData.visits.filter(v => v.restId === id); document.getElementById('detail-visits').innerText = visits.length; document.getElementById('detail-reviews').innerHTML = visits.length === 0 ? '<p class="text-slate-500 text-sm">No visits yet.</p>' : visits.map(v => `<div class="bg-slate-800 p-4 rounded-xl border border-slate-700"><div class="flex justify-between text-xs text-slate-400 mb-2"><span>${new Date(v.date).toLocaleDateString()}</span><span>£${v.spend}</span></div><p class="text-slate-200 text-sm italic">"${v.notes}"</p><div class="mt-2 flex gap-1 text-brand-500 text-xs">${renderStars(v.ratings.food)}</div></div>`).join(''); document.getElementById('modal-detail').classList.remove('hidden'); }
        function toggleSaveDetail() { const existing = appData.restaurants.find(r => r.id === currentDetailId); if (existing && existing.status === 'want_to_try') { appData.restaurants = appData.restaurants.filter(r => r.id !== currentDetailId); } else if (!existing) { const mock = MOCK_DB.find(r => r.id === currentDetailId); if (mock) appData.restaurants.push({ ...mock, status: 'want_to_try' }); } saveData(); openDetail(currentDetailId); }
        function makeReservation() { const date = prompt("Date (YYYY-MM-DD):", new Date().toISOString().split('T')[0]); const time = prompt("Time:", "19:00"); const people = prompt("People:", "2"); if(date && time) { appData.bookings.push({ id: Date.now(), name: document.getElementById('detail-name').innerText, date, time, people }); saveData(); alert(`Booked!`); closeModal('modal-detail'); changeView('bookings'); } }
        function cancelBooking(id) { if(confirm("Cancel?")) { appData.bookings = appData.bookings.filter(b => b.id != id); saveData(); } }
        function openAddModal() { document.getElementById('modal-add').classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function openReviewMode() { closeModal('modal-detail'); openAddModal(); document.getElementById('log-name').value = document.getElementById('detail-name').innerText; }
        function changeView(view) { document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden')); document.getElementById(`view-${view}`).classList.remove('hidden'); if(view === 'visited-list') { populateVisitedFilters(); renderVisitedList(); } if(view === 'map') { initMap(); } if(view !== 'discover') document.getElementById('main-scroll').scrollTop = 0; }
        function clearVisitFilters() { document.getElementById('visit-search').value = ''; document.getElementById('visit-filter-loc').value = 'all'; document.getElementById('visit-filter-cuisine').value = 'all'; document.getElementById('visit-filter-rating').value = 'all'; renderVisitedList(); }
        function renderStars(n) { return Array(5).fill(0).map((_, i) => `<i class="ph ${i < n ? 'ph-star-fill' : 'ph-star'}"></i>`).join(''); }
        function updateDatalist() { const dl = document.getElementById('restaurant-list'); const allNames = [...new Set([...appData.restaurants.map(r=>r.name), ...MOCK_DB.map(r=>r.name)])]; dl.innerHTML = allNames.map(n => `<option value="${n}">`).join(''); }
        function goHome() { try { window.parent.goHome(); } catch(e) { changeView('discover'); } }

        init();
    </script>
</body>
</html>