<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#020617">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://fav.farm/ðŸ§ ">

    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('sw.js').then(reg => console.log('JoshOS v22 Active'));
        });
      }
    </script>

    <title>JoshOS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        if (!localStorage.getItem('brain_session')) window.location.href = 'login.html';
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { brain: { bg: '#020617', card: '#0f172a', border: '#1e293b', accent: '#38bdf8' } }
                }
            }
        }
    </script>
    <style>
        body { background-color: #020617; color: white; -webkit-tap-highlight-color: transparent; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Futuristic App Card Style */
        .app-card {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(16px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .app-card:active { transform: scale(0.98); background: rgba(15, 23, 42, 0.8); }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-brain-bg font-sans">

    <main class="flex-1 flex flex-col h-full overflow-hidden w-full relative">
        
        <header class="h-20 flex items-center justify-between px-6 z-10 shrink-0 bg-transparent pt-4">
            <div>
                <p class="text-[11px] font-bold text-brain-accent uppercase tracking-widest mb-1 opacity-80" id="date-display">LOADING...</p>
                <h1 class="text-2xl font-bold text-white"><span id="greeting-text">Hello</span>, Josh.</h1>
            </div>
            <button onclick="openSettings()" class="w-11 h-11 rounded-full bg-slate-800/50 border border-slate-700/50 overflow-hidden backdrop-blur-md relative z-20">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Josh" class="w-full h-full" id="header-avatar">
            </button>
        </header>

        <div id="view-dashboard" class="flex-1 overflow-y-auto overflow-x-hidden p-6 space-y-6 pb-12 hide-scroll">
            <div id="dashboard-apps" class="space-y-5">
                </div>

            <button onclick="openModuleModal()" class="w-full py-5 mt-4 border-2 border-dashed border-slate-800/50 rounded-3xl text-slate-500 text-sm font-bold uppercase tracking-widest flex items-center justify-center gap-3 hover:border-brain-accent/50 hover:text-brain-accent transition-all backdrop-blur-sm">
                <i class="ph ph-plus-bold text-lg"></i> Add Module
            </button>
        </div>

        <div id="view-app-viewer" class="hidden absolute inset-0 bg-brain-bg z-50 flex flex-col h-full w-full">
            <div class="h-14 bg-brain-card/80 backdrop-blur-xl border-b border-brain-border/50 flex items-center justify-between px-4 shrink-0">
                <button onclick="goBack()" class="p-2 text-slate-400 hover:text-white flex items-center gap-2 py-3"><i class="ph ph-caret-left text-xl"></i> <span class="font-medium">Back</span></button>
                <span id="current-app-title" class="font-bold text-white text-sm tracking-wider uppercase">App</span>
                <div class="w-16"></div>
            </div>
            <iframe id="app-frame" class="flex-1 w-full bg-[#020617] border-0"></iframe>
        </div>

    </main>

    <div id="settings-modal" class="fixed inset-0 bg-black/90 backdrop-blur-md hidden z-[100] flex items-center justify-center p-6">
        <div class="bg-slate-900/80 backdrop-blur-xl w-full max-w-lg rounded-[2rem] border border-slate-800/50 p-8 shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500"></div>
            <h3 class="text-2xl font-bold text-white mb-6">Settings</h3>
            <div class="space-y-5">
                <div><label class="text-xs text-slate-500 uppercase font-bold ml-2">Display Name</label><input id="settings-name" class="w-full bg-black/50 border border-slate-700/50 rounded-2xl px-5 py-4 text-white mt-1 focus:outline-none focus:border-brain-accent/50 transition-colors"></div>
                <div><label class="text-xs text-slate-500 uppercase font-bold ml-2">Gemini API Key</label><input type="password" id="settings-api-key" class="w-full bg-black/50 border border-slate-700/50 rounded-2xl px-5 py-4 text-white mt-1 focus:outline-none focus:border-brain-accent/50 transition-colors"></div>
                <div class="grid grid-cols-2 gap-3 pt-2">
                    <button onclick="resetApps()" class="text-xs text-red-400 bg-red-500/10 border border-red-500/20 p-4 rounded-2xl font-bold hover:bg-red-500/20 transition-colors">Reset App List</button>
                    <button onclick="exportData()" class="text-xs text-brain-accent bg-brain-accent/10 border border-brain-accent/20 p-4 rounded-2xl font-bold hover:bg-brain-accent/20 transition-colors">Export Data</button>
                </div>
                <button onclick="logout()" class="w-full py-4 bg-slate-800/50 text-slate-300 border border-slate-700/50 rounded-2xl text-sm font-bold hover:bg-slate-800 transition-colors">Sign Out</button>
            </div>
            <div class="flex gap-4 mt-8">
                <button onclick="document.getElementById('settings-modal').classList.add('hidden')" class="flex-1 py-4 bg-slate-800/50 text-white rounded-2xl font-bold border border-slate-700/50">Cancel</button>
                <button onclick="saveSettings()" class="flex-1 py-4 bg-gradient-to-r from-blue-600 to-blue-400 text-white rounded-2xl font-bold shadow-lg shadow-blue-500/30">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="module-modal" class="fixed inset-0 bg-black/90 backdrop-blur-md hidden z-[100] flex items-center justify-center p-6"><div class="bg-slate-900/80 backdrop-blur-xl w-full max-w-sm rounded-[2rem] border border-slate-800/50 p-8 shadow-2xl"><h3 class="font-bold text-2xl text-white mb-6">Add App</h3><div class="space-y-4"><input type="text" id="mod-title" placeholder="App Name" class="w-full bg-black/50 border border-slate-700/50 rounded-2xl px-5 py-4 text-white focus:outline-none focus:border-brain-accent/50"><input type="text" id="mod-desc" placeholder="Description" class="w-full bg-black/50 border border-slate-700/50 rounded-2xl px-5 py-4 text-white focus:outline-none focus:border-brain-accent/50"><div class="flex gap-3"><input type="text" id="mod-icon" placeholder="Icon (e.g. ph-cube)" class="w-full bg-black/50 border border-slate-700/50 rounded-2xl px-5 py-4 text-white focus:outline-none focus:border-brain-accent/50"><input type="text" id="mod-color" placeholder="Color (e.g. blue)" class="w-full bg-black/50 border border-slate-700/50 rounded-2xl px-5 py-4 text-white focus:outline-none focus:border-brain-accent/50"></div><input type="text" id="mod-url" placeholder="Path (e.g. apps/myapp.html)" class="w-full bg-black/50 border border-slate-700/50 rounded-2xl px-5 py-4 text-white focus:outline-none focus:border-brain-accent/50"></div><div class="flex gap-4 mt-8"><button onclick="document.getElementById('module-modal').classList.add('hidden')" class="flex-1 py-4 bg-slate-800/50 text-slate-300 rounded-2xl font-bold border border-slate-700/50">Cancel</button><button onclick="saveModule()" class="flex-1 py-4 bg-gradient-to-r from-brain-accent to-blue-500 text-slate-900 rounded-2xl font-bold shadow-lg shadow-blue-500/20">Add App</button></div></div></div>

    <script>
        // The Master List of Default Apps
        const defaultApps = [
            {id:'finance',title:"Vault Finance",desc:"Budget & Cashflow",icon:"ph-wallet",color:"emerald",url:"apps/finance.html"},
            {id:'crm',title:"Personal CRM",desc:"Network Relationships",icon:"ph-users-three",color:"indigo",url:"apps/Personalcrm.html"},
            {id:'food',title:"Gourmet Tracker",desc:"Wishlist & Reviews",icon:"ph-bowl-food",color:"orange",url:"apps/restaurantindex.html"},
            {id:'todo',title:"Task Master",desc:"Projects & Goals",icon:"ph-check-square",color:"green",url:"apps/todo.html"},
        ];
        
        let myApps = JSON.parse(localStorage.getItem('brain_apps')) || defaultApps;

        function init() {
            loadUserData();
            
            // --- AUTO-REPAIR: Ensure all default apps (like CRM) are present ---
            let needsSave = false;
            defaultApps.forEach(defApp => {
                if (!myApps.find(a => a.id === defApp.id)) {
                    myApps.push(defApp); // Add missing app
                    needsSave = true;
                }
            });
            if (needsSave) {
                localStorage.setItem('brain_apps', JSON.stringify(myApps));
            }
            // -------------------------------------------------------------------

            renderApps();
            document.getElementById('date-display').innerText = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' }).toUpperCase();
        }

        function renderApps() { 
            const c = document.getElementById('dashboard-apps'); 
            c.innerHTML = ''; 
            if(!myApps || myApps.length === 0) { c.innerHTML = '<p class="text-slate-500 text-center py-10">No apps installed.</p>'; return; }
            
            const colorMap = { emerald: '16, 185, 129', green: '34, 197, 94', indigo: '99, 102, 241', purple: '168, 85, 247', orange: '249, 115, 22', blue: '59, 130, 246', pink: '236, 72, 153' };

            myApps.forEach((a,i) => {
                const rgb = colorMap[a.color] || colorMap['blue'];
                const cardStyle = `border-color: rgba(${rgb}, 0.3); box-shadow: 0 8px 24px -6px rgba(${rgb}, 0.2);`;
                const iconStyle = `color: rgb(${rgb}); border-color: rgba(${rgb}, 0.4); background-color: rgba(${rgb}, 0.1); box-shadow: inset 0 0 12px rgba(${rgb}, 0.1);`;

                c.innerHTML += `
                    <div onclick="openApp(${i})" class="app-card p-5 rounded-[2rem] flex items-center gap-5 cursor-pointer select-none relative overflow-hidden group" style="${cardStyle}">
                        <div class="absolute inset-0 bg-gradient-to-r from-[rgba(${rgb},0.05)] to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                        <div class="w-16 h-16 rounded-2xl flex items-center justify-center shrink-0 border relative z-10 transition-transform group-hover:scale-110 duration-300" style="${iconStyle}">
                            <i class="ph ${a.icon} text-3xl drop-shadow-sm"></i>
                        </div>
                        <div class="flex-1 min-w-0 relative z-10">
                            <h3 class="font-bold text-white text-xl tracking-tight mb-0.5 group-hover:text-brain-accent transition-colors">${a.title}</h3>
                            <p class="text-sm text-slate-400 font-medium truncate opacity-70">${a.desc || 'Module'}</p>
                        </div>
                        <div class="w-12 h-12 rounded-full bg-slate-800/30 flex items-center justify-center text-slate-500/70 border border-slate-700/30 group-hover:border-brain-accent/30 group-hover:text-brain-accent transition-all relative z-10">
                            <i class="ph ph-caret-right-bold text-lg"></i>
                        </div>
                    </div>
                `;
            }); 
        }

        function openApp(i) { 
            const a = myApps[i]; 
            document.getElementById('current-app-title').innerText = a.title; 
            document.getElementById('app-frame').src = a.url; 
            document.getElementById('view-dashboard').classList.add('hidden'); 
            document.getElementById('view-app-viewer').classList.remove('hidden'); 
        }

        function goBack() { 
            document.getElementById('app-frame').src = ""; 
            document.getElementById('view-app-viewer').classList.add('hidden'); 
            document.getElementById('view-dashboard').classList.remove('hidden'); 
        }

        function resetApps() { localStorage.setItem('brain_apps', JSON.stringify(defaultApps)); window.location.reload(); }
        function loadUserData(){const u=JSON.parse(localStorage.getItem('brain_user'))||{name:'Josh'};document.getElementById('greeting-text').innerText=new Date().getHours()<12?'Good Morning':'Good Afternoon';if(u.avatar)document.getElementById('header-avatar').src=u.avatar;}
        function openSettings(){document.getElementById('settings-modal').classList.remove('hidden');const u=JSON.parse(localStorage.getItem('brain_user'))||{name:'User'};document.getElementById('settings-name').value=u.name;document.getElementById('settings-api-key').value=localStorage.getItem('brain_gemini_key')||'';}
        function saveSettings(){const name=document.getElementById('settings-name').value;localStorage.setItem('brain_user',JSON.stringify({name}));localStorage.setItem('brain_gemini_key',document.getElementById('settings-api-key').value);loadUserData();document.getElementById('settings-modal').classList.add('hidden');}
        function openModuleModal(){document.getElementById('module-modal').classList.remove('hidden');}
        function saveModule(){const t=document.getElementById('mod-title').value;if(!t)return;const n={id:'app-'+Date.now(),title:t,desc:document.getElementById('mod-desc').value,icon:document.getElementById('mod-icon').value||'ph-cube',color:'blue',url:document.getElementById('mod-url').value};myApps.push(n);localStorage.setItem('brain_apps',JSON.stringify(myApps));renderApps();document.getElementById('module-modal').classList.add('hidden');}
        function exportData(){const d={...localStorage};const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=`JoshOS_Backup.json`;a.click();URL.revokeObjectURL(u);}
        function logout() { localStorage.removeItem('brain_session'); window.location.href='login.html'; }

        init();
    </script>
</body>
</html>