<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#020617">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://fav.farm/üß†">

    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', async () => {
          // 1. Get all existing service workers
          const registrations = await navigator.serviceWorker.getRegistrations();
          
          // 2. Unregister them all (Force kill the old version)
          for(let registration of registrations) {
            await registration.unregister();
            console.log('Old Service Worker Killed üíÄ');
          }

          // 3. Register the NEW one with a unique ID
          navigator.serviceWorker.register('sw.js?v=12').then(reg => {
             console.log('New Service Worker Registered ‚ú®');
             
             // 4. Force reload if we just killed an old one
             if (registrations.length > 0 && !sessionStorage.getItem('reloaded')) {
                 sessionStorage.setItem('reloaded', 'true');
                 window.location.reload();
             }
          });
        });
      }
    </script>

    <title>JoshOS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    
    <script>
        if (!localStorage.getItem('brain_session')) window.location.href = 'login.html';
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { brain: { bg: '#020617', card: '#0f172a', border: '#1e293b', accent: '#38bdf8' } }
                }
            }
        }
    </script>
    <style>
        body { background-color: #020617; color: white; -webkit-tap-highlight-color: transparent; }
        .hide-scroll::-webkit-scrollbar { display: none; }

        /* Widget Cards */
        .widget-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.4), rgba(15, 23, 42, 0.6));
            border: 1px solid rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
        }

        /* News Ticker */
        @keyframes ticker { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        .ticker-wrap { overflow: hidden; white-space: nowrap; }
        .ticker-move { display: inline-block; animation: ticker 30s linear infinite; }

        /* Navigation Styles */
        .nav-item { transition: color 0.2s; }
        .nav-item.active { color: #38bdf8; }
        .nav-item.active i { font-weight: bold; }
        
        /* Floating Action Button (FAB) */
        .fab-container { 
            position: absolute; top: -24px; left: 50%; transform: translateX(-50%); 
            background: #020617; padding: 6px; border-radius: 50%; 
            border-top: 1px solid #1e293b;
            box-shadow: 0 -10px 20px rgba(0,0,0,0.2);
        }
        .fab-btn { 
            width: 56px; height: 56px; 
            background: linear-gradient(135deg, #38bdf8, #2563eb); 
            border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            box-shadow: 0 4px 20px rgba(56, 189, 248, 0.4); 
            color: white; font-size: 28px; 
            transition: transform 0.1s; 
        }
        .fab-btn:active { transform: scale(0.9); }

        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-brain-bg">

    <aside class="w-72 bg-brain-card border-r border-brain-border hidden lg:flex flex-col fixed h-full z-50">
        <div class="h-20 flex items-center px-6"><i class="ph ph-brain text-brain-accent text-3xl mr-3"></i><span class="font-bold text-xl">JoshOS</span></div>
        <nav class="p-4 space-y-2">
            <button onclick="switchTab('dashboard')" class="w-full flex items-center h-12 px-4 bg-slate-800 rounded-xl text-sm font-bold text-white"><i class="ph ph-squares-four text-lg mr-3"></i> Dashboard</button>
            <button onclick="switchTab('apps')" class="w-full flex items-center h-12 px-4 hover:bg-slate-800 rounded-xl text-sm font-medium text-slate-400"><i class="ph ph-grid-four text-lg mr-3"></i> Apps</button>
            <button onclick="openSettings()" class="w-full flex items-center h-12 px-4 hover:bg-slate-800 rounded-xl text-sm font-medium text-slate-400"><i class="ph ph-gear text-lg mr-3"></i> Settings</button>
        </nav>
    </aside>

    <main class="flex-1 flex flex-col h-full overflow-hidden relative lg:ml-72 w-full">
        
        <header class="h-16 flex items-center justify-between px-5 z-10 shrink-0 bg-brain-bg/90 backdrop-blur-md border-b border-brain-border/50 sticky top-0">
            <div>
                <p class="text-[10px] font-bold text-brain-accent uppercase tracking-widest mb-0.5" id="date-display">LOADING...</p>
                <h1 class="text-xl font-bold text-white"><span id="greeting-text">Hello</span>, Josh.</h1>
            </div>
            <button onclick="openSettings()" class="w-9 h-9 rounded-full bg-slate-800 border border-slate-700 overflow-hidden">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Josh" class="w-full h-full" id="header-avatar">
            </button>
        </header>

        <div id="view-dashboard" class="flex-1 overflow-y-auto overflow-x-hidden p-5 pb-32 space-y-5">
            
            <div class="grid grid-cols-2 gap-3 h-28">
                <div class="widget-card rounded-2xl p-3 flex flex-col justify-between relative overflow-hidden">
                    <div class="flex justify-between items-start z-10">
                        <div>
                            <span class="text-3xl font-bold" id="weather-temp">--¬∞</span>
                            <p class="text-[10px] text-slate-400" id="weather-desc">Loading...</p>
                        </div>
                        <i class="ph ph-cloud-sun text-2xl text-yellow-400"></i>
                    </div>
                    <div class="text-[10px] text-slate-500 z-10 flex items-center gap-1"><i class="ph ph-map-pin"></i> London</div>
                    <div class="absolute -right-4 -bottom-4 w-20 h-20 bg-blue-500/20 rounded-full blur-xl"></div>
                </div>

                <div class="widget-card rounded-2xl p-3 flex flex-col justify-between relative overflow-hidden">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                        <span class="text-[10px] font-bold text-slate-400 uppercase">Trends</span>
                    </div>
                    <div class="space-y-1">
                        <div class="flex justify-between text-[10px]"><span class="text-slate-300">S&P 500</span><span class="text-emerald-400 font-bold">‚Üó 1.2%</span></div>
                        <div class="flex justify-between text-[10px]"><span class="text-slate-300">BTC</span><span class="text-emerald-400 font-bold">‚Üó 0.8%</span></div>
                        <div class="flex justify-between text-[10px]"><span class="text-slate-300">GBP</span><span class="text-red-400 font-bold">‚Üò 0.1%</span></div>
                    </div>
                </div>
            </div>

            <div class="widget-card rounded-xl py-2 px-3 overflow-hidden flex items-center gap-3">
                <span class="text-[9px] font-bold bg-red-500/20 text-red-400 px-1.5 py-0.5 rounded">NEWS</span>
                <div class="ticker-wrap flex-1">
                    <div class="ticker-move text-xs text-slate-300 font-medium">
                        üöÄ Tech stocks rally as AI adoption grows  ‚Ä¢  üåç Global climate summit reaches new agreement  ‚Ä¢  üß† JoshOS v12 updates UI & Forms  ‚Ä¢  ‚òï New productivity hacks trending  ‚Ä¢ 
                    </div>
                </div>
            </div>

            <div class="widget-card p-5 rounded-3xl relative overflow-hidden group cursor-pointer" onclick="openApp(myApps.findIndex(a => a.id === 'todo'))">
                <div class="absolute top-0 right-0 p-4 opacity-10"><i class="ph ph-target text-8xl text-brain-accent group-hover:scale-110 transition-transform"></i></div>
                <div class="relative z-10">
                    <span class="bg-brain-accent/10 text-brain-accent border border-brain-accent/20 px-2.5 py-0.5 rounded-lg text-[10px] font-bold uppercase tracking-wider">Up Next</span>
                    <div id="dashboard-focus-content" class="mt-3">
                        <p class="text-xl font-bold text-white leading-tight">Loading tasks...</p>
                    </div>
                </div>
            </div>

            <div>
                <h2 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-3">Quick Launch</h2>
                <div class="grid grid-cols-4 gap-3">
                    <button onclick="openApp(myApps.findIndex(a => a.id === 'todo'))" class="flex flex-col items-center gap-1.5">
                        <div class="w-14 h-14 rounded-2xl bg-slate-800 border border-slate-700 flex items-center justify-center text-slate-400 active:scale-95 transition-transform"><i class="ph ph-check-square text-2xl"></i></div>
                        <span class="text-[10px] text-slate-500">Tasks</span>
                    </button>
                    <button onclick="openApp(myApps.findIndex(a => a.id === 'crm'))" class="flex flex-col items-center gap-1.5">
                        <div class="w-14 h-14 rounded-2xl bg-slate-800 border border-slate-700 flex items-center justify-center text-slate-400 active:scale-95 transition-transform"><i class="ph ph-users text-2xl"></i></div>
                        <span class="text-[10px] text-slate-500">CRM</span>
                    </button>
                    <button onclick="openApp(myApps.findIndex(a => a.id === 'journal'))" class="flex flex-col items-center gap-1.5">
                        <div class="w-14 h-14 rounded-2xl bg-slate-800 border border-slate-700 flex items-center justify-center text-slate-400 active:scale-95 transition-transform"><i class="ph ph-book-bookmark text-2xl"></i></div>
                        <span class="text-[10px] text-slate-500">Log</span>
                    </button>
                    <button onclick="switchTab('apps')" class="flex flex-col items-center gap-1.5">
                        <div class="w-14 h-14 rounded-2xl bg-slate-800 border border-slate-700 flex items-center justify-center text-slate-400 active:scale-95 transition-transform"><i class="ph ph-dots-nine text-2xl"></i></div>
                        <span class="text-[10px] text-slate-500">More</span>
                    </button>
                </div>
            </div>
        </div>

        <div id="view-apps" class="hidden flex-1 overflow-y-auto p-5 pb-32">
            <h2 class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4">All Modules</h2>
            <div id="apps-container" class="grid grid-cols-1 gap-3">
                </div>
            <button onclick="openModuleModal()" class="w-full py-4 mt-6 border border-dashed border-slate-700 rounded-2xl text-slate-500 text-xs font-bold uppercase tracking-widest flex items-center justify-center gap-2 hover:border-brain-accent hover:text-brain-accent transition-colors">
                <i class="ph ph-plus"></i> Add Module
            </button>
        </div>

        <div id="view-app-viewer" class="hidden absolute inset-0 bg-brain-bg z-50 flex flex-col h-full w-full">
            <div class="h-14 bg-brain-card border-b border-brain-border flex items-center justify-between px-2 shrink-0">
                <button onclick="goBack()" class="p-3 text-slate-400 hover:text-white flex items-center gap-1"><i class="ph ph-caret-left text-lg"></i> Back</button>
                <span id="current-app-title" class="font-bold text-white text-sm">App</span>
                <div class="w-12"></div>
            </div>
            <iframe id="app-frame" class="flex-1 w-full bg-black border-0"></iframe>
        </div>

    </main>

    <nav class="fixed bottom-0 left-0 w-full h-[88px] bg-brain-card/95 backdrop-blur-xl border-t border-brain-border flex justify-between items-start px-6 pt-4 z-40 lg:hidden pb-safe">
        
        <button onclick="switchTab('dashboard')" class="nav-item active flex flex-col items-center gap-1 w-12" id="nav-dashboard">
            <i class="ph ph-house-fill text-2xl"></i>
            <span class="text-[10px] font-bold">Home</span>
        </button>

        <button onclick="switchTab('apps')" class="nav-item text-slate-500 flex flex-col items-center gap-1 w-12" id="nav-apps">
            <i class="ph ph-grid-four text-2xl"></i>
            <span class="text-[10px] font-medium">Apps</span>
        </button>

        <div class="relative w-12 flex justify-center">
            <div class="fab-container">
                <button onclick="openQuickCapture()" class="fab-btn">
                    <i class="ph ph-plus-bold text-white"></i>
                </button>
            </div>
        </div>

        <button onclick="openAiModal('Thinking...')" class="nav-item text-slate-500 flex flex-col items-center gap-1 w-12">
            <i class="ph ph-sparkle text-2xl"></i>
            <span class="text-[10px] font-medium">AI</span>
        </button>

        <button onclick="openSettings()" class="nav-item text-slate-500 flex flex-col items-center gap-1 w-12">
            <i class="ph ph-user text-2xl"></i>
            <span class="text-[10px] font-medium">Profile</span>
        </button>
    </nav>

    <div id="quick-add-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-[100] flex items-end justify-center">
        <div class="bg-slate-900 w-full rounded-t-3xl border-t border-slate-800 p-6 pb-12 animate-slide-up transition-all duration-300">
            
            <div id="qa-menu">
                <h3 class="text-center text-slate-400 text-xs font-bold uppercase tracking-widest mb-6">Quick Capture</h3>
                <div class="grid grid-cols-4 gap-3">
                    <button onclick="showQaForm('task')" class="flex flex-col items-center gap-2 p-3 bg-slate-800 rounded-2xl active:scale-95 transition-transform">
                        <div class="w-10 h-10 rounded-full bg-green-500 flex items-center justify-center text-white"><i class="ph ph-check text-xl"></i></div>
                        <span class="text-[10px] font-bold text-white">Task</span>
                    </button>
                    <button onclick="showQaForm('journal')" class="flex flex-col items-center gap-2 p-3 bg-slate-800 rounded-2xl active:scale-95 transition-transform">
                        <div class="w-10 h-10 rounded-full bg-purple-500 flex items-center justify-center text-white"><i class="ph ph-pencil-simple text-xl"></i></div>
                        <span class="text-[10px] font-bold text-white">Journal</span>
                    </button>
                    <button onclick="showQaForm('expense')" class="flex flex-col items-center gap-2 p-3 bg-slate-800 rounded-2xl active:scale-95 transition-transform">
                        <div class="w-10 h-10 rounded-full bg-emerald-500 flex items-center justify-center text-white"><i class="ph ph-currency-dollar text-xl"></i></div>
                        <span class="text-[10px] font-bold text-white">Expense</span>
                    </button>
                    <button onclick="showQaForm('food')" class="flex flex-col items-center gap-2 p-3 bg-slate-800 rounded-2xl active:scale-95 transition-transform">
                        <div class="w-10 h-10 rounded-full bg-orange-500 flex items-center justify-center text-white"><i class="ph ph-bowl-food text-xl"></i></div>
                        <span class="text-[10px] font-bold text-white">Food</span>
                    </button>
                </div>
            </div>

            <div id="qa-task" class="hidden">
                <div class="flex justify-between items-center mb-4"><h3 class="text-white font-bold">New Task</h3><button onclick="resetQa()" class="text-xs text-slate-400">Back</button></div>
                <input type="text" id="t-title" placeholder="Task Name" class="w-full bg-black border border-slate-800 rounded-xl px-4 py-3 mb-3 text-white focus:border-brain-accent focus:outline-none">
                <input type="date" id="t-date" class="w-full bg-black border border-slate-800 rounded-xl px-4 py-3 mb-3 text-white focus:border-brain-accent focus:outline-none">
                <select id="t-prio" class="w-full bg-black border border-slate-800 rounded-xl px-4 py-3 mb-3 text-white">
                    <option value="high">High Priority</option>
                    <option value="medium" selected>Medium Priority</option>
                    <option value="low">Low Priority</option>
                </select>
                <button onclick="saveQuickTask()" class="w-full py-3 bg-green-600 rounded-xl font-bold text-white">Save Task</button>
            </div>

            <div id="qa-journal" class="hidden">
                <div class="flex justify-between items-center mb-4"><h3 class="text-white font-bold">New Entry</h3><button onclick="resetQa()" class="text-xs text-slate-400">Back</button></div>
                <input type="text" id="j-title" placeholder="Title" class="w-full bg-black border border-slate-800 rounded-xl px-4 py-3 mb-3 text-white">
                <textarea id="j-body" placeholder="What's on your mind?" class="w-full bg-black border border-slate-800 rounded-xl px-4 py-3 mb-3 text-white h-24 resize-none"></textarea>
                <div class="flex gap-2 mb-4">
                    <button onclick="setMood('Happy')" class="mood-btn flex-1 py-2 bg-slate-800 rounded-lg text-xs">üòä</button>
                    <button onclick="setMood('Neutral')" class="mood-btn flex-1 py-2 bg-slate-800 rounded-lg text-xs">üòê</button>
                    <button onclick="setMood('Sad')" class="mood-btn flex-1 py-2 bg-slate-800 rounded-lg text-xs">üòî</button>
                </div>
                <button onclick="saveQuickJournal()" class="w-full py-3 bg-purple-600 rounded-xl font-bold text-white">Save Entry</button>
            </div>

            <div id="qa-expense" class="hidden">
                <div class="flex justify-between items-center mb-4"><h3 class="text-white font-bold">New Expense</h3><button onclick="resetQa()" class="text-xs text-slate-400">Back</button></div>
                <input type="number" id="e-amount" placeholder="Amount ($)" class="w-full bg-black border border-slate-800 rounded-xl px-4 py-3 mb-3 text-white">
                <input type="text" id="e-desc" placeholder="Description (e.g. Coffee)" class="w-full bg-black border border-slate-800 rounded-xl px-4 py-3 mb-3 text-white">
                <select id="e-cat" class="w-full bg-black border border-slate-800 rounded-xl px-4 py-3 mb-3 text-white">
                    <option value="Food">Food</option>
                    <option value="Transport">Transport</option>
                    <option value="Shopping">Shopping</option>
                    <option value="Bills">Bills</option>
                </select>
                <button onclick="saveQuickExpense()" class="w-full py-3 bg-emerald-600 rounded-xl font-bold text-white">Log Expense</button>
            </div>

            <div id="qa-food" class="hidden">
                <div class="flex justify-between items-center mb-4"><h3 class="text-white font-bold">Restaurant</h3><button onclick="resetQa()" class="text-xs text-slate-400">Back</button></div>
                <input type="text" id="f-name" placeholder="Restaurant Name" class="w-full bg-black border border-slate-800 rounded-xl px-4 py-3 mb-3 text-white">
                <select id="f-status" class="w-full bg-black border border-slate-800 rounded-xl px-4 py-3 mb-3 text-white">
                    <option value="wishlist">Want to Go (Wishlist)</option>
                    <option value="visited">Visited (Review)</option>
                </select>
                <div id="f-rating-box" class="hidden mb-3">
                    <input type="number" id="f-rating" placeholder="Rating (1-5)" max="5" min="1" class="w-full bg-black border border-slate-800 rounded-xl px-4 py-3 text-white">
                </div>
                <button onclick="saveQuickFood()" class="w-full py-3 bg-orange-600 rounded-xl font-bold text-white">Save Place</button>
            </div>

            <button onclick="closeQuickCapture()" class="w-full mt-6 py-4 text-slate-500 font-bold border-t border-slate-800">Close</button>
        </div>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-6">
        <div class="bg-slate-900 w-full max-w-sm rounded-3xl border border-slate-800 shadow-2xl overflow-hidden flex flex-col max-h-[80vh]">
            <div class="p-6 border-b border-slate-800 bg-slate-900 z-10">
                <h3 class="font-bold text-xl text-white">Settings</h3>
            </div>
            
            <div class="p-6 overflow-y-auto space-y-8">
                <div>
                    <h4 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-3">Profile</h4>
                    <div class="space-y-3">
                        <div><label class="text-xs text-slate-400">Display Name</label><input type="text" id="settings-name" class="w-full bg-black border border-slate-800 rounded-lg px-3 py-2 text-white mt-1"></div>
                        <div><label class="text-xs text-slate-400">Avatar URL</label><input type="text" id="settings-avatar" placeholder="https://..." class="w-full bg-black border border-slate-800 rounded-lg px-3 py-2 text-white mt-1"></div>
                    </div>
                </div>

                <div>
                    <h4 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-3">System</h4>
                    <div class="space-y-3">
                        <div><label class="text-xs text-slate-400">Gemini API Key</label><input type="password" id="settings-api-key" class="w-full bg-black border border-slate-800 rounded-lg px-3 py-2 text-white mt-1"></div>
                        <div class="flex items-center justify-between py-2 border-b border-slate-800">
                            <span class="text-sm text-slate-300">Notifications</span>
                            <div class="w-10 h-6 bg-green-500 rounded-full flex items-center justify-end px-1"><div class="w-4 h-4 bg-white rounded-full"></div></div>
                        </div>
                    </div>
                </div>

                <div>
                    <h4 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-3">Data Management</h4>
                    <div class="space-y-2">
                        <button onclick="exportData()" class="w-full py-3 bg-slate-800 hover:bg-slate-700 rounded-xl text-sm font-bold text-slate-300 border border-slate-700 flex items-center justify-center gap-2"><i class="ph ph-download"></i> Export All Data</button>
                        <button onclick="importData()" class="w-full py-3 bg-slate-800 hover:bg-slate-700 rounded-xl text-sm font-bold text-slate-300 border border-slate-700 flex items-center justify-center gap-2"><i class="ph ph-upload"></i> Import Backup</button>
                        <input type="file" id="import-file" style="display:none" onchange="processImport(this)">
                    </div>
                </div>
                
                <button onclick="logout()" class="w-full py-3 bg-red-500/10 text-red-400 border border-red-500/20 rounded-xl text-sm font-bold">Sign Out</button>
                <p class="text-[10px] text-center text-slate-600 pt-2">JoshOS v11.0.1</p>
            </div>

            <div class="p-4 border-t border-slate-800 flex gap-3 bg-slate-900 z-10">
                <button onclick="document.getElementById('settings-modal').classList.add('hidden')" class="flex-1 py-3 bg-slate-800 text-slate-300 rounded-xl font-bold">Cancel</button>
                <button onclick="saveSettings()" class="flex-1 py-3 bg-brain-accent text-slate-900 rounded-xl font-bold">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="ai-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-[100] flex items-end sm:items-center justify-center sm:p-4"><div class="bg-slate-900 w-full sm:max-w-lg rounded-t-3xl sm:rounded-3xl border-t sm:border border-slate-800 shadow-2xl flex flex-col max-h-[85vh]"><div class="p-5 border-b border-slate-800 flex justify-between items-center bg-slate-900 rounded-t-3xl"><h3 class="font-bold text-white">Gemini AI</h3><button onclick="document.getElementById('ai-modal').classList.add('hidden')"><i class="ph ph-x text-slate-400"></i></button></div><div class="p-6 overflow-y-auto text-sm leading-relaxed text-slate-300" id="ai-modal-body"></div></div></div>
    <div id="module-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-6"><div class="bg-slate-900 w-full max-w-sm rounded-3xl border border-slate-800 p-6 shadow-2xl"><h3 class="font-bold text-xl text-white mb-4">Add App</h3><div class="space-y-3"><input type="text" id="mod-title" placeholder="App Name" class="w-full bg-black border border-slate-800 rounded-xl px-4 py-3 text-white"><input type="text" id="mod-desc" placeholder="Description" class="w-full bg-black border border-slate-800 rounded-xl px-4 py-3 text-white"><div class="flex gap-2"><input type="text" id="mod-icon" placeholder="Icon" class="w-full bg-black border border-slate-800 rounded-xl px-4 py-3 text-white"><input type="text" id="mod-color" placeholder="Color" class="w-full bg-black border border-slate-800 rounded-xl px-4 py-3 text-white"></div><input type="text" id="mod-url" placeholder="Path" class="w-full bg-black border border-slate-800 rounded-xl px-4 py-3 text-white"></div><div class="flex gap-3 mt-6"><button onclick="document.getElementById('module-modal').classList.add('hidden')" class="flex-1 py-3 bg-slate-800 text-slate-300 rounded-xl font-bold">Cancel</button><button onclick="saveModule()" class="flex-1 py-3 bg-brain-accent text-slate-900 rounded-xl font-bold">Add</button></div></div></div>

    <script>
        const defaultApps = [
            { id: 'finance', title: "Vault Finance", desc: "Budget & Cashflow", icon: "ph-wallet", color: "emerald", url: "apps/finance.html" },
            { id: 'crm', title: "Personal CRM", desc: "Network & Calendar", icon: "ph-users-three", color: "indigo", url: "apps/Personalcrm.html" },
            { id: 'food', title: "Gourmet Tracker", desc: "Wishlist & Reviews", icon: "ph-bowl-food", color: "orange", url: "apps/restaurantindex.html" },
            { id: 'todo', title: "Task Master", desc: "To-Do List & Goals", icon: "ph-check-square", color: "green", url: "apps/todo.html" },
            { id: 'journal', title: "Mind Log", desc: "Reflections", icon: "ph-book-bookmark", color: "purple", url: "apps/journalapp.html" }
        ];

        let myApps = JSON.parse(localStorage.getItem('brain_apps')) || defaultApps;
        let selectedMood = 'Neutral';

        function init() {
            loadUserData();
            renderApps();
            fetchWeather();
            document.getElementById('date-display').innerText = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' }).toUpperCase();
            
            document.getElementById('f-status').addEventListener('change', function() {
                document.getElementById('f-rating-box').style.display = this.value === 'visited' ? 'block' : 'none';
            });
            document.getElementById('t-date').value = new Date().toISOString().split('T')[0];
        }

        // --- QUICK CAPTURE LOGIC ---
        function openQuickCapture() { resetQa(); document.getElementById('quick-add-modal').classList.remove('hidden'); }
        function closeQuickCapture() { document.getElementById('quick-add-modal').classList.add('hidden'); }
        function resetQa() {
            document.getElementById('qa-menu').classList.remove('hidden');
            ['qa-task','qa-journal','qa-expense','qa-food'].forEach(id => document.getElementById(id).classList.add('hidden'));
            // Clear inputs
            document.getElementById('t-title').value = '';
            document.getElementById('j-title').value = ''; document.getElementById('j-body').value = '';
            document.getElementById('e-amount').value = ''; document.getElementById('e-desc').value = '';
            document.getElementById('f-name').value = ''; document.getElementById('f-rating').value = '';
        }
        function showQaForm(type) {
            document.getElementById('qa-menu').classList.add('hidden');
            document.getElementById(`qa-${type}`).classList.remove('hidden');
        }
        
        function saveQuickTask() {
            const title = document.getElementById('t-title').value;
            const date = document.getElementById('t-date').value;
            const prio = document.getElementById('t-prio').value;
            if(!title) return alert("Task Name Required");
            const tasks = JSON.parse(localStorage.getItem('tm_tasks')) || [];
            tasks.push({ id: Date.now(), title, status: 'pending', priority: prio, dueDate: date });
            localStorage.setItem('tm_tasks', JSON.stringify(tasks));
            closeQuickCapture(); updateFocusWidget(); alert("Task Saved!");
        }

        function setMood(mood) { selectedMood = mood; alert('Mood: ' + mood); }
        function saveQuickJournal() {
            const title = document.getElementById('j-title').value;
            const body = document.getElementById('j-body').value;
            if(!title) return alert("Title Required");
            const entries = JSON.parse(localStorage.getItem('jn_entries')) || [];
            entries.unshift({ id: Date.now(), title, body, date: new Date().toISOString(), mood: selectedMood });
            localStorage.setItem('jn_entries', JSON.stringify(entries));
            closeQuickCapture(); alert("Entry Saved!");
        }

        function saveQuickExpense() {
            const amount = document.getElementById('e-amount').value;
            const desc = document.getElementById('e-desc').value;
            const cat = document.getElementById('e-cat').value;
            if(!amount) return alert("Amount Required");
            const txs = JSON.parse(localStorage.getItem('fin_transactions')) || [];
            txs.unshift({ id: Date.now(), amount: parseFloat(amount), category: cat, description: desc, date: new Date().toISOString(), type: 'expense' });
            localStorage.setItem('fin_transactions', JSON.stringify(txs));
            closeQuickCapture(); alert("Expense Logged!");
        }

        function saveQuickFood() {
            const name = document.getElementById('f-name').value;
            const status = document.getElementById('f-status').value;
            const rating = document.getElementById('f-rating').value;
            if(!name) return alert("Name Required");
            const places = JSON.parse(localStorage.getItem('journal_restaurants')) || [];
            places.unshift({ id: Date.now(), name, status, rating: status === 'visited' ? rating : null, date: new Date().toISOString() });
            localStorage.setItem('journal_restaurants', JSON.stringify(places));
            closeQuickCapture(); alert("Restaurant Saved!");
        }

        // --- DATA MANAGEMENT ---
        function exportData() {
            const data = { ...localStorage };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `JoshOS_Backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click(); URL.revokeObjectURL(url);
        }
        function importData() { document.getElementById('import-file').click(); }
        function processImport(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    Object.keys(data).forEach(key => localStorage.setItem(key, data[key]));
                    alert("Data Restored Successfully!"); window.location.reload();
                } catch(err) { alert("Invalid Backup File"); }
            };
            reader.readAsText(file);
        }

        // --- STANDARD LOGIC ---
        async function fetchWeather() {
            try {
                const req = await fetch('https://api.open-meteo.com/v1/forecast?latitude=51.5&longitude=-0.1&current=temperature_2m,weather_code&daily=temperature_2m_max,temperature_2m_min&timezone=Europe%2FLondon');
                const data = await req.json();
                const temp = Math.round(data.current.temperature_2m);
                document.getElementById('weather-temp').innerText = `${temp}¬∞`;
                document.getElementById('weather-desc').innerText = getWeatherDesc(data.current.weather_code);
            } catch(e) { console.log('Weather Error'); }
        }
        function getWeatherDesc(code) { if(code===0)return 'Clear Sky'; if(code<4)return 'Cloudy'; if(code<80)return 'Rainy'; return 'Snowy'; }

        function switchTab(tabId) {
            ['view-dashboard', 'view-apps'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(`view-${tabId}`).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item i').forEach(el => el.classList.remove('text-brain-accent'));
            document.querySelectorAll('.nav-item span').forEach(el => el.classList.remove('font-bold'));
            const btn = document.getElementById(`nav-${tabId}`);
            if(btn) { btn.classList.add('active'); btn.querySelector('i').classList.add('text-brain-accent'); btn.querySelector('span').classList.add('font-bold'); }
        }
        function goBack() { document.getElementById('app-frame').src = ""; document.getElementById('view-app-viewer').classList.add('hidden'); document.querySelector('nav').classList.remove('hidden'); document.getElementById('view-dashboard').classList.remove('hidden'); updateFocusWidget(); }
        function openApp(index) { const app = myApps[index]; document.getElementById('current-app-title').innerText = app.title; document.getElementById('app-frame').src = app.url; ['view-dashboard', 'view-apps'].forEach(id => document.getElementById(id).classList.add('hidden')); document.getElementById('view-app-viewer').classList.remove('hidden'); document.querySelector('nav').classList.add('hidden'); }
        function renderApps() { const c = document.getElementById('apps-container'); c.innerHTML=''; myApps.forEach((app,i) => { const d=document.createElement('div'); d.className=`p-4 rounded-2xl bg-slate-800/50 border border-slate-700/50 flex items-center gap-4 cursor-pointer active:bg-slate-800`; d.onclick=()=>openApp(i); d.innerHTML=`<div class="w-12 h-12 bg-${app.color}-500/10 rounded-xl flex items-center justify-center text-${app.color}-400 shrink-0 border border-${app.color}-500/20"><i class="ph ${app.icon} text-2xl"></i></div><div class="flex-1"><h3 class="font-bold text-white text-base">${app.title}</h3><p class="text-xs text-slate-400">${app.desc}</p></div><i class="ph ph-caret-right text-slate-600"></i>`; c.appendChild(d); }); updateFocusWidget(); }
        function updateFocusWidget() { const el=document.getElementById('dashboard-focus-content'); try { const t=JSON.parse(localStorage.getItem('tm_tasks'))||[]; const p=t.filter(x=>x.status==='pending'); if(p.length>0) el.innerHTML=`<p class="text-xl font-bold text-white truncate">${p[0].title}</p><p class="text-xs text-brain-accent mt-1">Due: ${p[0].dueDate}</p>`; else el.innerHTML=`<p class="text-xl text-slate-400 font-bold">All caught up!</p>`; } catch(e){ el.innerHTML=`<p class="text-sm text-slate-500">No tasks found.</p>`; } }
        function openSettings(){document.getElementById('settings-modal').classList.remove('hidden');const u=JSON.parse(localStorage.getItem('brain_user'))||{name:'User'};document.getElementById('settings-name').value=u.name;document.getElementById('settings-avatar').value=u.avatar||'';document.getElementById('settings-api-key').value=localStorage.getItem('brain_gemini_key')||'';}
        function saveSettings(){const name=document.getElementById('settings-name').value;const avatar=document.getElementById('settings-avatar').value;localStorage.setItem('brain_user',JSON.stringify({name,avatar}));localStorage.setItem('brain_gemini_key',document.getElementById('settings-api-key').value);loadUserData();document.getElementById('settings-modal').classList.add('hidden');}
        function logout() { localStorage.removeItem('brain_session'); window.location.href='login.html'; }
        function loadUserData(){const u=JSON.parse(localStorage.getItem('brain_user'))||{name:'Josh'};document.getElementById('greeting-text').innerText=new Date().getHours()<12?'Good Morning':'Good Afternoon';if(u.avatar)document.getElementById('header-avatar').src=u.avatar;}
        function openModuleModal(){document.getElementById('module-modal').classList.remove('hidden');}
        function saveModule(){const t=document.getElementById('mod-title').value;if(!t)return;const n={id:'app-'+Date.now(),title:t,desc:document.getElementById('mod-desc').value,icon:document.getElementById('mod-icon').value||'ph-cube',color:'blue',url:document.getElementById('mod-url').value};myApps.push(n);localStorage.setItem('brain_apps',JSON.stringify(myApps));renderApps();document.getElementById('module-modal').classList.add('hidden');}
        async function handleSearch(e){if(e.key==='Enter'){const q=e.target.value;if(!q)return;openAiModal('Thinking...');e.target.value='';const r=await callGemini(`User query: ${q}. Answer concisely in markdown.`);document.getElementById('ai-modal-body').innerHTML=marked.parse(r);}}
        async function callGemini(p){const k=localStorage.getItem('brain_gemini_key');if(!k)return "Please set API Key in settings.";try{const r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${k}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:p}]}]})});const d=await r.json();return d.candidates[0].content.parts[0].text;}catch(e){return "Error connecting to AI.";}}
        function openAiModal(t){document.getElementById('ai-modal').classList.remove('hidden');document.getElementById('ai-modal-body').innerHTML=`<p class="text-center text-slate-400 animate-pulse">${t}</p>`;}

        init();
    </script>
</body>
</html>